define("FxInternal/ExtensionRuntime",["require","exports","Fx/DependencyInjection","FxInternal/Composition/ViewModelComposer","FxInternal/RpcEndPoints","FxHubs/ProvisioningRpc","FxInternal/Weave/SandboxRender","FxInternal/ResourceManagement/Permissions","FxInternal/Environment","FxInternal/Weave/Blade","FxInternal/RpcEndPointsCore","FxInternal/Composition/ViewModelAdapters","FxInternal/Composition/ViewModelComposer","FxInternal/Experimentation","FxInternal/Composition/ViewModelComposer","FxInternal/RpcEndPointsCore","Fx"],(function(e,t,n,r,o,i,a,s,c,l,u,d,m,f,p,x,g){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DEV=t.getInnerRuntime=t.ensureInitialized=t.Runtime=t.InnerRuntime=t.getExtensionDefinedResourceAccessInfo=t.loadBladeDefinition=void 0;var v=MsPortalFx.Base,h=v.Diagnostics,I=FxImpl.Extension,_=h.Telemetry,F=0,P=MsPortalFx.Base.Diagnostics.Telemetry.Context.getBladeContext,E=v.Diagnostics.createLog(e),y=MsPortalFx.isFeatureEnabled("logwarningsforunmigratedextensions"),M=MsPortalFx.isFeatureEnabled("enableauthtelemetry"),w={noncaearm:!0},C={};function k(e){var t=e.resourceName,n=e.logData,r=e.telemetryData;!y||w[t.toLowerCase()]||C[t]||(C[t]=!0,r?_.trace({source:"ExtensionRuntime",action:r.action,data:r.data}):(null==n?void 0:n.message)&&E.warning(null==n?void 0:n.message))}function b(e,t){return MsPortalFx.pathJoin("/",e.extensionRoot,t)}function R(e,t,n){return F++,Q(MsPortalFx.require(MsPortalFx.ensureSuffix(e,"/")+n)).then((function(e){return void 0===(n=e[t]).trustedLinkedDomains&&(n.trustedLinkedDomains=MsPortalFx.getEnvironmentValue("trustedLinkedDomains",null)),n;var n})).catch((function(e){if("data"in e){var r="Failed to retrieve the ".concat(t," definition for '").concat(n,"' from the server.\r\n"),o=e.data&&e.data.failedModules&&1===e.data.failedModules.length?e.data.failedModules[0].message:e.message,i="".concat(r).concat(o);throw FxImpl.createError(i,{innerErrors:e,data:e.data})}throw e}))}function T(e,t){return __awaiter(this,void 0,void 0,(function(){var n,o,i,a,s,c;return __generator(this,(function(l){switch(l.label){case 0:return o=MsPortalFx.startTimer(),FxImpl.features.isNativePerf&&(n="ExtLoadBladeBundles: ".concat(r.getLocatorFriendlyName(t).toLowerCase()),performance.mark(n)),[4,R(e,"blade",t)];case 1:return i=l.sent(),a=MsPortalFx.clone(i,!0),[4,r.getViewModelClass(a.viewModelLocator)];case 2:return s=l.sent(),c=(0,d.isWeaveEnabled)(s),s&&s._fx&&s._fx.rebindable&&1&a.attributes&&(a.attributes&=-2),a.reflowReady=!0,c&&!a.isWeave&&(a.isWeave=!0,a.templateBlade.htmlTemplateInline=null,a.templateBlade.styleSheets=null),n&&performance.measure(n,n),a.viewModelBundleLoading||(a.viewModelBundleLoading={end:Date.now(),duration:o()}),[2,a]}}))}))}function D(e){var t=e.resourceName,n=e.extensionName,r=e.authorization;if(t&&"telemetrytoken"!==t.toLowerCase()&&![v.Constants.Shell,"HubsExtension"].includes(n)){var o=r?r.resourceAccess?"":"However, no 'resourceAccess' property was found in the extension-defined configuration":"However, this extension has not migrated to the extension-defined auth configuration";o&&k({resourceName:t,logData:{message:"The extension '".concat(n,"' has requested a token for resource '").concat(t,"'. ").concat(o,". ").concat("Please follow the instructions here: https://github.com/Azure/portaldocs/blob/bb7a801c811884f3fe9ce4abe7afc8196c18004c/portal-sdk/generated/top-extensions-authentication-procedures.md#migrating-resource-access-configuration. For additional questions, please join our teams channel at http://aka.ms/portalfx/resourceaccessteams.")}});var i=MsPortalFx.find(null==r?void 0:r.resourceAccess,(function(e){return e.name===t}));if(i)return k({resourceName:t,telemetryData:{action:"getResourceAccessInfo",data:__assign({},i)}}),i;k({resourceName:t,logData:{message:"The extension '".concat(n,"' has requested a token for resource '").concat(t,"'. However, extension-defined resource access configuration does not contain an entry for this resource. Please add the resource to the entension's configuration before making this request again.")}})}return null}t.loadBladeDefinition=T,t.getExtensionDefinedResourceAccessInfo=D;var A=function(){function t(e,t){var r=this;this._rpcClient=e,this._permissionChecker=t,this._ltm=new FxImpl.TriggerableLifetimeManager,this._extensionAssignments=Promise.withResolvers(),h.ErrorReporter.initialize(),this._extensionName=MsPortalFx.getEnvironmentValue("extensionName");var o=this._authorization=MsPortalFx.getEnvironmentValue("authorization");o&&o.resourceAccess&&(this._authorization={resourceAccess:o.resourceAccess.map((function(e){return __assign(__assign({},e),{name:e.name.toLowerCase()})}))}),this._tokenCache=v.Security.createAuthTokenCache((function(t){return I.getAuthorizationTokenEndPoint.invoke(e,"fx",t)}),FxImpl.postBootEnv.tokens);var i=new Map,a=[];I.getReactModelEndPoint.register(e,"fx",(function(t){var o=e.detachPort("fx",t.portId),s=new FxImpl.TriggerableLifetimeManager;i.set(t.portId,s);var c=t.modelName?Q(MsPortalFx.require(t.modelName)):Q(MsPortalFx.Models.React);Promise.all([c,MsPortalFx.require("@microsoft/azureportal-reactview/internal/FunctionProxy")]).then((function(i){var c=i[0],l=i[1];if(!s.isDisposed()){var u=function(){var t;return(t=FxImpl.NetDiagnostics.pendingAjaxCalls).concat.apply(t,e.getPendingInvokes())},d=new l.FunctionProxyImpl,m=new l.AsyncStoreImpl(d,(function(e){return __awaiter(r,void 0,void 0,(function(){var t,n;return __generator(this,(function(r){switch(r.label){case 0:return t=u(),[4,e()];case 1:return r.sent(),(n=u().filter((function(e){return!t.includes(e)&&!a.includes(e)}))).forEach((function(e){Promise.race([g.delay(6e4),e.promise.catch((function(){}))]).finally((function(){MsPortalFx.remove(a,e)}))})),a.push.apply(a,n),[2,Promise.all(n.map((function(e){return e.promise.catch((function(){}))}))).then((function(){return{asyncOperations:n.map((function(e){return e.name}))}}))]}}))}))})).initialized();new c({lifetime:s,asyncStore:m,functionProxy:d,extensionAssignments:r._extensionAssignments.promise,viewParameters:t.parameters,diContainer:n.container}),d.setPort(o)}}))})),I.disposeReactModelEndPoint.register(e,"fx",(function(e){var t=e.portId;i.get(t).dispose(),e.unrequire&&FxImpl.unrequire(e.modelName)})),I.pingEndPoint.register(e,"fx",MsPortalFx.noop),I.getLocalGalleryPackagesEndpointDefinition.register(e,"fx",(function(){var e=MsPortalFx.getEnvironmentValue("localGalleryPackageEndpoint");return e&&FxImpl.ensureAbsoluteUri(e)})),MsPortalFx.Base.Net2.status.subscribe(this._ltm,(function(t){I.extensionStatusEndPoint.invoke(e,"fx",t)})),MsPortalFx.Base.Net2.initialize((function(e){return MsPortalFx.tryImmediateResolve(r.getAuthorizationToken(e),(function(e){return e&&e.header}))}))}return t.prototype.getAuthorizationToken=function(e){var t,n=MsPortalFx.getFeatureValue("authstamp"),r=null===(t=(e=e||{}).resourceName)||void 0===t?void 0:t.toLowerCase(),o=this._extensionName,i=e.audience||"",a=e.tenantId||"",s=D({resourceName:r,extensionName:o,authorization:this._authorization});return s&&(i=s.resource,a=s.useInfrastructureTenant?FxImpl.internalEnv.fxAadInfrastructureTenantId:a,e=__assign(__assign({},e),{resourceName:r,audience:i,tenantId:a})),n&&(e=__assign(__assign({},e),{authConfigStamp:n})),M&&_.trace({source:"ExtensionRuntime",action:"getAuthorizationToken",data:{audience:e.audience||"___NOTFOUND___",authConfigStamp:e.authConfigStamp,isBackground:e.isBackground,resourceName:e.resourceName,tenantId:e.tenantId}}),Q(this._tokenCache.getToken(e))},t.prototype.getSharedSettings=function(){return this._settingsCache||(this._settingsCache=I.getSharedSettingsEndPoint.invoke(this._rpcClient,"fx",void 0))},t.prototype.getUserInfo=function(){return I.getUserInfoEndPoint.invoke(this._rpcClient,"fxw",void 0)},t.prototype.assetHasPermission=function(e,t){var n=this;return this.mapAssetIdToResourceId(e).then((function(e){return n._permissionChecker.hasPermission(e,t)}))},t.prototype.mapAssetIdToResourceId=function(e){return I.mapAssetIdToResourceIdEndPoint.invoke(this._rpcClient,"fx",e)},t.prototype.mapResourceIdToAssetId=function(e){return I.mapResourceIdToAssetIdEndPoint.invoke(this._rpcClient,"fx",e)},t.prototype.mapAssetIdToDynamicSelectionAndIcon=function(e,t){return I.mapAssetIdToDynamicSelectionAndIconEndPoint.invoke(this._rpcClient,"fx",{assetId:e,forceBladeSelection:t})},t.prototype.mapResourceIdToDynamicSelectionAndIcon=function(e,t){return I.mapResourceIdToDynamicSelectionAndIconEndPoint.invoke(this._rpcClient,"fx",{resourceId:e,forceBladeSelection:t})},t.prototype.getAssetTypeInformation=function(e,t){return I.getAssetTypeInformationEndPoint.invoke(this._rpcClient,"fx",{extensionName:e,assetType:t})},t.prototype.getResourceTypeAssetTypeInformation=function(e){return I.getResourceTypeAssetTypeInformationEndPoint.invoke(this._rpcClient,"fx",e)},t.prototype.getResourceAssetInformation=function(e){return I.getResourceAssetInformationEndPoint.invoke(this._rpcClient,"fx",e)},t.prototype.getResource=function(e,t,n){return I.getResourceEndPoint.invoke(this._rpcClient,"fx",{resourceId:e,skipCache:n,invoker:t})},t.prototype.dispose=function(){this._ltm.dispose()},t.prototype.resolveExtensionAssignments=function(e){this._extensionAssignments.resolve(e)},t=__decorate([__metadata("fx:diagnostics",[e,"InnerRuntime"]),n.Class(),__metadata("design:paramtypes",[FxImpl.Rpc.Client,s.PermissionChecker])],t)}();function N(e){var t="Cannot find view model class for '".concat(e,"'. Maybe it is not correctly exported?");throw E.error(t),new MsPortalFx.Errors.CanceledError(t)}t.InnerRuntime=A;var B=function(){function t(e,t,n,s){var c=this,d=n.sdkEnv,f=b(d,"_generated/Blades");i.register(e);var v={requireConfig:MsPortalFx.getEnvironmentValue("requireConfig"),extensionEnvironment:FxImpl.postBootEnv.environment||fx.environment,features:FxImpl.features.value};I.postBootEndPoint.invoke(e,"fx",v),x.getPostBootEndPoint.register(e,"fxw",(function(){return v}));var h=new r.ViewModelProvider(d,{getPartViewModel:N,getViewModel:N},e,(function(e,t){return S(e,t)})),_=e.pendingInvocationCount,y=ko.observable(_.totalCount);_.subscribe(y);var M,w=FxImpl.NetDiagnostics.pendingCallCount,C=ko.pureComputed((function(){return w()+y()})),k=function(e){if(e)return e!==(null==M?void 0:M.instanceId)&&(M={instanceId:e,interruptedParent:C()>0}),M.interruptedParent};I.getBladeDefinitionEndPoint.register(e,"fx",(function(e){return T(f,e).then((function(e){return __assign({},e)}))})),I.downloadBladeBundlesEndPoint.register(e,null,(function(e){T(f,e)})),I.getPartDefinitionEndPoint.register(e,"fx",(function(e){return R(b(d,"_generated/Parts"),"part",e)})),u.setExtensionFlightsEndPoint.register(e,"fxw",(function(e){return MsPortalFx.require("FxInternal/Experimentation").then((function(n){return t.get(n.ExperimentationManager).setExtensionFlights(e)}))}));var D=function(e){var t;return null===(t=A(e))||void 0===t?void 0:t.instanceId},A=function(e){var t;return FxImpl.TelemetryContext.usingState((function(){t=P()}),e),t};r.getViewModelsDefinition.registerChannelFactory(e,(function(e,n){var r,o=64&e.type,i=o&&k(D(e.telemetryContext)),a=(null===(r=null==e?void 0:e.onInputsSetParameters)||void 0===r?void 0:r.inputs)||{},s=h.getObservable(t.createChildContainer("viewModel").set(l.UntypedWeaveBladeParameters,a),n,e);return o&&(s=s.then((function(e){return e.internal.interruptedParent=i,e}))),s})),r.tryEarlyGetViewModelEndPoint.registerChannelFactory(e,(function(e,n){var r=F,o=Date.now()-e.timestamp,i=e.bladeName,s=e.parameters||{},c=t.createChildContainer("viewModel").set(l.UntypedWeaveBladeParameters,s),u="Blade_".concat(MsPortalFx.sessionId,"_").concat(e.options.sequenceNumber,"_0"),m=k(u);return a.isWeaveBladeEnabled&&function(e,t,n){var r=n&&MsPortalFx.isFeatureEnabled("bladeprefetch2")&&n.weaveBladesMap&&n.weaveBladesMap[t],o=r&&r.prewarmerDependencies,i=0;o&&MsPortalFx.tryImmediateResolve(MsPortalFx.require(b(n,"PrewarmerEntryPoint")),(function(t){for(var n=0,r=o;n<r.length;n++){var a=r[n];e.get(t[a])}i=o.length})),i&&E.verbose("Successfully processed ".concat(i," prewarmer dependencies for '").concat(t,"'."))}(c,i,d),T(f,i).then((function(t){return h.tryEarlyGetViewModel(c,i,s,e.options,t,n).then((function(e){return e&&(e.internal.interruptedParent=m),{definition:t,rpcDurationMs:o,viewModel:e,viewModelLoadIndex:r}}))}))})),I.getExtensionGalleryService.registerObjectFactory(e,{allowedOrigin:null,allowRemoteChanges:!0,handler:function(){return h.getGalleryServiceViewModel(t.createChildContainer("viewModel"))}}),o.registerRpcEndPoints(t),I.getCommandsDefinitionEndPoint.register(e,"fx",(function(){return MsPortalFx.require(b(d,"_generated/Commands"))}));var B=Object.create(null),S=function(e,t){return __awaiter(c,void 0,void 0,(function(){var n=this;return __generator(this,(function(r){return[2,B[t]||(B[t]=new Promise((function(r){var o,i,a="ExtBladeAjaxEnd: ".concat(t),s=function(e){void 0===e&&(e=!1),delete B[t],e?r(null):(null==o||o.dispose(),r({waitEnd:fx.getTimestamp(),interruptedByChild:t&&t!==(null==M?void 0:M.instanceId),lastAjaxCompleteTime:i,lastAjaxCompleteMark:a}))};0===C()?s():(o=e.createChildLifetime(),e.registerForDispose((function(){s(!0)})),C.subscribe(o,(function(e){return __awaiter(n,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return 0!==e?[3,3]:[4,g.delay(0)];case 1:return t.sent(),[4,g.delay(0)];case 2:t.sent(),0===C()&&s(),t.label=3;case 3:return[2]}}))}))})),w.subscribe(o,(function(e){0===e&&(i=fx.getTimestamp(),FxImpl.features.isNativePerf&&performance.mark(a))})))})))]}))}))};I.waitForExtensionIdleEndPoint.register(e,null,(function(e,t,n){return __awaiter(c,[e,t,n],void 0,(function(e,t,n){var r,o,i,a,s,c,l=e.bladeName,u=e.bladeInstanceId;return __generator(this,(function(e){switch(e.label){case 0:return FxImpl.features.isNativePerf&&(r="ExtWaitForIdle: ".concat((0,m.getLocatorFriendlyName)(l).toLowerCase()),performance.mark(r)),o=C(),i=fx.getTimestamp(),[4,S(n,u)];case 1:return(a=e.sent())?(FxImpl.features.isNativePerf&&performance.measure(r,r),s=a.interruptedByChild,c=a.waitEnd,[2,{interruptedByChild:s,pendingOperationsCount:o,waitDuration:0===o?0:c-i}]):[2,null]}}))}))}));var V=new Map;I.onNewReactViewEndPoint.register(e,"fx",(function(e){var t=e.viewName,n=e.sequenceNumber,r=(0,p.getEarlyViewModelTelemetryContext)(t,n),o=D(r),i=FxImpl.NetDiagnostics.listenForBlade(A(r));V.set(o,i),k(o)})),I.onReactViewInteractiveEndPoint.register(e,null,(function(e){var t=e.bladeInstanceId,n=e.time,r=V.get(t);null==r||r.onInteractive(n)})),I.onReactViewDisposed.register(e,"fx",(function(e){var t=e.viewName,n=e.sequenceNumber;(0,V.get(D((0,p.getEarlyViewModelTelemetryContext)(t,n))).onDisposed)()})),I.traceToExtensionEndPoint.register(e,"fx",(function(e){var t=e[0],n=e[1];FxImpl.TelemetryContext.usingState((function(){MsPortalFx.Base.Diagnostics.Telemetry.trace(t)}),n)})),I.endTraceToExtensionEndPoint.register(e,"fx",(function(e){var t=e[0],n=e[1],r=e[2],o=e[3],i=e[4];return FxImpl.TelemetryContext.usingState((function(){var e=MsPortalFx.Base.Diagnostics.Telemetry.startTrace(__assign(__assign({},t),{duration:n-t.timestamp}));return MsPortalFx.Base.Diagnostics.Telemetry.endTrace(e,r,o)}),i)}))}return t=__decorate([__metadata("fx:diagnostics",[e,"Runtime"]),n.Class(),__metadata("design:paramtypes",[FxImpl.Rpc.Client,n.Container,c.Environment,A])],t)}();t.Runtime=B,t.ensureInitialized=function(){var t=n.container,r=t.set(c.Environment,{extensionName:MsPortalFx.getEnvironmentValue("extensionName"),sdkEnv:MsPortalFx.getEnvironmentValue("sdkEnv"),shellTrustedLinkedDomains:FxImpl.internalEnv.shellTrustedLinkedDomains,trustedLinkedDomains:MsPortalFx.getEnvironmentValue("trustedLinkedDomains"),linkedDomainMap:FxImpl.internalEnv.linkedDomainMap}).get(FxImpl.Rpc.Client);r.start({instanceIndex:FxImpl.postBootEnv.instanceIndex,loadChannelFunction:void 0,originId:FxImpl.postBootEnv.extensionName,shellChannel:new FxImpl.Rpc.RpcChannel(FxImpl.localRpcPort),windowRedirectMap:FxImpl.postBootEnv.extensionRedirectMap}),function(t){(FxImpl.isDevelopmentMode||MsPortalFx.isFeatureEnabled("internalonly"))&&g.nextTick((function(){var n=["ai_session","ai_user","ARRAffinity","VstsSession"],r=["ai_authUser","mp_"],o=[];if((document.cookie||"").split(";").map((function(e){return e.split("=")[0].trim()})).forEach((function(e){r.forEach((function(t){e.startsWith(t)&&(o.push(e),document.cookie="".concat(e,"=;expires=Thu, 01 Jan 1970 00:00:00 UTC"))}))})),o.length&&t.log("fx",{level:2,area:e.normalize("."),code:0,message:"Deleted cookie(s) for ".concat(MsPortalFx.getEnvironmentValue("extensionName"),": ").concat(o.join())}),document.__lookupGetter__&&document.__lookupSetter__){var i=document.__lookupGetter__("cookie"),a=document.__lookupSetter__("cookie");i&&a&&(document.__defineGetter__("cookie",i.bind(document)),document.__defineSetter__("cookie",(function(r){var o=r.split("=")[0].trim();return n.includes(o)?a.call(document,r):(t.log("fx",{level:2,area:e.normalize("."),code:0,message:"Blocking cookie for ".concat(MsPortalFx.getEnvironmentValue("extensionName"),": ").concat(o)}),"")})))}}))}(r),t.set(f.ExperimentationManager,new f.ExperimentationManager({shellVariants:FxImpl.postBootEnv.shellVariants,features:FxImpl.features,trace:function(e){r.invokeRpc(FxImpl.Constants.RpcMethods.networkTelemetry,MsPortalFx.Base.Constants.Shell,e)},onVariantsAssigned:function(e){var t=e.variables,r=Object.keys(t);if(r.length){var o="azureportal_",i=r.reduce((function(e,n){return e[n.startsWith(o)?n.slice(12):n]=t[n],e}),Object.create(null));FxImpl.addQueryOverride({experimentationvariables:i})}n.container.get(A).resolveExtensionAssignments(e)}})).get(B),FxImpl.features.isNativePerf&&["PortalScripts","Oss","MsPortalFx"].forEach((function(e){performance.measure(MsPortalFx.getEnvironmentValue("extensionName")+": "+e,e+"Start",e+"End")}))},t.getInnerRuntime=function(){return n.container.get(A)}}));