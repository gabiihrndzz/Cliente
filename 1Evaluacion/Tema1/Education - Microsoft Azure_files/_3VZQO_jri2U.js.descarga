define("MsPortalImpl/UI/Hubs/UI.FavoritesManagerDeferred",["require","exports","Fx/DependencyInjection","MsPortalImpl/Services/Services.AssetTypes","MsPortalImpl/Services/Services.BrowseCuration","MsPortalImpl/UI/Hubs/UI.BrowseManager","MsPortalImpl/UI/Hubs/UI.FavoritesManager","_oss/fuse","Fx/Controls/Toolbar","MsPortalImpl/Services/Services.Recents","FxHubs/ResourceManagement","MsPortalImpl/Resources/ImplScriptResources","Fx","FxHubs/ArtHelpers/ArgBrowseHelpers","MsPortalImpl/Services/Services.AssetTypes","Fx/Composition/Selectable","MsPortalImpl/UI/UI.BladeOpener","MsPortalImpl/Base/Base.Router"],(function(e,s,t,i,o,r,a,n,l,c,d,p,h,u,m,y,g,b){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.getServiceCreateLink=s.getServiceAssetTypeManifest=s.getServiceBrowseDeepLink=s.FavoritesManagerDeferred=s.tokenFavoritesPerCategory=s.tokenFavorites=void 0;var v=MsPortalFx.Base,f=v.Constants.AssetNames,T=FxImpl.Assets,C=v.Diagnostics,k=C.Telemetry,M=l.ToolbarItems.createBasicButton;C.createLog(e);const F=/\s+/g,I=MsPortalFx.find,w=MsPortalFx.stableSort,_={shouldSort:!0,includeScore:!0,includeMatches:!0,tokenize:!0,threshold:.3,location:0,distance:100,maxPatternLength:32,minMatchCharLength:2,keys:[{name:"label",weight:.9},{name:"keywords",weight:.3},{name:"resourceType",weight:.1}]},P=MsPortalFx.extend({matchAllTokens:!0},_);function S(e,s,t){return s===f.BrowseResourceGroupBlade&&(s=f.ResourceGroups),T.getAssetTypeOrResourceTypeIdByWindowId(e,s)+(t?"."+t.toLowerCase():"")}function L(e,s){const t=s.toLocaleLowerCase(),i=[],o=[];return e.forEach((e=>{e.item.assetType.compositeDisplayName.service.toLocaleLowerCase().startsWith(t)?i.push(e):o.push(e)})),i.concat(o)}function x(e,s,t,i){let o=new n(s,t?P:_).search(e);o=o.filter((e=>e.score<=_.threshold));const r=o.reduce(((e,s)=>(function(e){if(e.item.boost)if(e.item.boost>2&&(e.item.boost=2),e.item.boost<-2&&(e.item.boost=-2),e.item.boost>0)e.score=Math.pow(e.score,1+e.item.boost);else if(e.item.boost<0){const s=1+Math.abs(e.item.boost);e.score=Math.pow(e.score,1/s)}}(s),s.score<=_.threshold&&e.push(s),e)),[]);if(r.sort(((e,s)=>e.score-s.score)),i){const s=i.find((s=>s.toLocaleLowerCase()===e.toLocaleLowerCase()));if(s?.length)return r}return L(r,e)}let B=class{constructor(e,s,t,r,n,l){this._assetTypeService=e,this._browseManager=s,this._favoritesManager=t,this._diContainer=r,this._recentsManager=n,this._router=l,this.categories=ko.observableArray(),this.categoriesLookup={},this.showCategories=ko.observable(!1),this.possibleFavorites=ko.observableArray(),this.possibleFavoritesLookup={},this._ltm=new FxImpl.TriggerableLifetimeManager,this._extensionToDefaultCategoryMap={},this._assetTypes=ko.observable(),this._categoriesInitialized=!1,this._categoriesWithSubCategoriesInitialized=!1,this._subCategoriesLocalizedNameMap={},this._recentsManager=this._diContainer.get(c.RecentServicesManager),this._assetTypes([]),MsPortalFx.tryImmediateResolve(this._assetTypeService.assetTypesComplete,(()=>{const e=this._browseManager.getFilteredAssetTypes()||[];e.length&&this._assetTypes(e)})),this.initializeCategories=(0,h.memoizePromise)((e=>{if(this._categoriesInitialized&&this._categoriesWithSubCategoriesInitialized){const s=e?this._categoriesWithSubCategories:this._categories;return Promise.resolve(s)}{const s=this._curationPromise||(0,o.getBrowseCuration)(e),t=MsPortalFx.isFeatureEnabled("allserviceswithoverview")?(0,o.getAllServicesAdditionalData)():Promise.resolve(null);return e?this._categoriesWithSubCategoriesInitialized=!0:this._categoriesInitialized=!0,Promise.all([s,t,this._assetTypeService.assetTypesComplete]).then((([s,t])=>{this._discoveryPolicy=s.discoveryPolicy||0,this._curationSearchKeywords=s.globalSearchKeywords;const o=(e,s)=>{const o=t&&t.categoriesDataMap[e],r={id:e,showLabel:ko.observable(!0),isFilteredOut:ko.observable(!1),isHidden:ko.pureComputed((()=>!r.possibleFavorites().some((e=>!e.isHidden())))),label:(0,i.provideCategoryName)(e),count:ko.observable(0),possibleFavorites:ko.observableArray(),sourceCategory:s,freeTrainings:o&&o.trainings,usefulLinks:o&&o.usefulLinks,seeAllTrainingsLink:o&&o.seeAllTrainingsLink};return r},r=s.categories||[],n=r.map((e=>o(e.id,e)));if(n&&n.length){const e=this._uncuratedCategory=o("uncurated");n.push(e)}this.categories(n),this.possibleFavorites().forEach((e=>{const s=a.getAssetTypeKind(e.assetType,e.kind),t=e.assetType,i=a.getAssetTypeDisplayText(t,s);e.label=i,e.labelId=i.replace(F,""),e.image=a.getAssetTypeIcon(t,s),e.keywords=(a.getAssetTypeKeywords(t,s)||"").split(","),e.isHidden(e.isHidden())}));const l={};return r.forEach((e=>{(e.discoveryExtensions||[]).forEach((s=>{l[s]=I(n,(s=>s.id===e.id))||this._uncuratedCategory}))})),this._extensionToDefaultCategoryMap=l,this._loadFlyoutMenu().then((s=>(e?this._categoriesWithSubCategories=s:this._categories=s,s)))}))}}))}updateForRecents(e,s){return this.initializeCategories(!!this._categoriesWithSubCategoriesInitialized||void 0).then((()=>this._recentsManager.getServices().then((t=>{const i=t&&t.length||0,o=e&&e.length;let r;if(s){if(e||(r=i>s?s:i),o>=s)return e.slice(0,s);r=s-o>=i?i:s-o}else r=i;if(0===r)return;const a=t.slice(0);a.sort(((e,s)=>s.timeStamp-e.timeStamp));const n=e&&e.slice(0)||[];for(let s=0;s<r;s++)if(!e||!MsPortalFx.find(e,(e=>a[s].assetId===e.id.toLowerCase()))){const e=this.possibleFavoritesLookup[a[s].assetId.toLowerCase()];e&&n.push({relevanceScore:ko.observable(1),id:e.id,image:e.image,isFavorite:e.isFavorite,label:e.label,labelId:e.labelId,keywords:e.keywords,matches:ko.observable(),uri:e.uri,opensExternal:e.opensExternal,isHidden:ko.observable(!1),isFilteredOut:ko.observable(!1),assetType:e.assetType,isPartner:e.isPartner,commandsToolbarDetailView:ko.observable()})}return n}))))}_filterServices(e,s,t,i,o,r){const a=new Set,n=[];if(e=e?.trim(),t||s.forEach((e=>{e.isFilteredOut(!1),e.relevanceScore(0),e.matches({highLightedDisplayName:"",highLightedSecondaryName:""})})),e){let i=x(e,s,!1,t?this._curationSearchKeywords:void 0);if(e.split(" ").length>1){const o=x(e,s,!0,t?this._curationSearchKeywords:void 0);i.push(...o),i.sort(((e,s)=>e.score-s.score));const r=this._curationSearchKeywords?.find((s=>s.toLocaleLowerCase()===e.toLocaleLowerCase()));r?.length||(i=L(i,e)),i=MsPortalFx.unique(i,((e,s)=>MsPortalFx.areEqual(e.item.id,s.item.id)))}const o={},l=2;let c,d=1;i.forEach((e=>{if(!e.item.isHidden()){let s="";if(r){const t=[],i=[],o=e.matches;for(let e=0;e<o?.length&&"label"!==o[e].key;e++){let s=0;const r=[],a=o[e].value?.length;o[e].indices.forEach((t=>{t[1]-t[0]>=l&&(r.push(o[e].value.slice(s,t[0])+"<b>"+o[e].value.slice(t[0],t[1]+1)+"</b>"),s=t[1]+1)})),s<a&&r.push(o[e].value.slice(s,a+1));const n=r.join("");switch(o[e].key){case"keywords":t.push(n);break;case"resourceType":i.push(n)}}const r=t.length&&`${p.Search.keywordSubNameFmt.format(t.join(","))}`,a=i.length&&`${p.Search.resourceTypeSubNameFmt.format(i.join(","))}`;s=r,s=a.length&&s.length?`${s}; ${a}`:s||a}else{const t=e.matches.filter((e=>"keywords"===e.key||"resourceType"===e.key));s=t[0]&&`${p.Search.keywordSubNameFmt.format(t[0].value.trim())}`}o[e.item.id]={relevance:d++,matchData:{highLightedDisplayName:"",highLightedSecondaryName:s}},a.add(e.item.id)}})),s.forEach((e=>{const s=o[e.id],i=s&&s.relevance||0,r=s&&s.matchData;t?s&&(c={relevanceScore:ko.observable(i),id:e.id,kind:e.kind,image:e.image,isFavorite:e.isFavorite,label:e.label,labelId:e.labelId,keywords:e.keywords,matches:ko.observable(r),uri:e.uri,opensExternal:e.opensExternal,isHidden:e.isHidden,isFilteredOut:ko.observable(!s),assetType:e.assetType,isDisabled:e.isDisabled,isPartner:e.isPartner,commandsToolbarDetailView:ko.observable()},n.push(c)):(e.relevanceScore(i),e.matches(r),e.isFilteredOut(!s))}))}return(i&&"All"!==i||o&&"All"!==o)&&s.forEach((e=>{const s=e.isFilteredOut(),r=function(e,s){const{releaseStatus:t,serviceProvider:i}=s,o=t&&("Preview"===t&&!e.isPreview||"GA"===t&&e.isPreview),r=i&&("Partner"===i&&!e.isPartner||"Microsoft"===i&&e.isPartner);return o||r}(e,{releaseStatus:i,serviceProvider:o}),l=s||r;l&&(a.delete(e.id),t?MsPortalFx.remove(n,e):e.isFilteredOut(l))})),{filteredTypes:t?n:s,matchCount:e?a.size:s.filter((e=>!e.isFilteredOut()&&!e.isHidden())).length}}filterAllServices(e){return e.possibleFavorites?.length?Promise.resolve(this._filterServices(e.filter,e.possibleFavorites,e.dontApplyVisibility,e.releaseStatus,e.serviceProvider,e.showKeywordAndTypeMatches)):this.initializeCategories().then((()=>Promise.resolve(this._filterServices(e.filter,this.possibleFavorites(),e.dontApplyVisibility,e.releaseStatus,e.serviceProvider,e.showKeywordAndTypeMatches))))}getCreateCommandForService(e){let s=e.assetTypeInfo.assetType?.assetTypeManifest||{};if(e.assetTypeInfo.kind&&e.assetTypeInfo.assetType.kindMap&&(s=e.assetTypeInfo.assetType.kindMap[e.assetTypeInfo.kind.toLowerCase()]||e.assetTypeInfo.assetType.assetTypeManifest),s.marketplaceItemId||s.marketplaceMenuItemId||s.noPdlCreateBlade)return M(e.lifetime,{label:e.buttonOptions.showLabel?p.ActionBarButtons.create:"",icon:e.buttonOptions.showIcon?e.buttonOptions.showCustomIcon?s.icon:MsPortalFx.Base.Images.Add():null,tooltip:p.Search.createCommandTitle,onClick:()=>{if(k.trace({source:e.source,name:e.assetTypeInfo.id,action:"CreateCommandClicked"}),s.marketplaceItemId)this._router.route(`#create/${s.marketplaceItemId}`,{openedBy:e.openedBy});else{const t=(0,u.getCreateBlade)({marketplaceItemId:s.marketplaceItemId,marketplaceMenuItemId:s.marketplaceMenuItemId,noPdlCreateBlade:s.noPdlCreateBlade,noPdlCreateExtension:s.noPdlCreateExtension,noPdlCreateParameters:s.noPdlCreateParameters,resourceType:s.resourceType?.resourceTypeName||e.assetTypeInfo.resourceType});this._diContainer.get(g.BladeOpener).openBlade(t,{flags:2,telemetryName:e.telemetryName})}return!1},disabled:e.assetTypeInfo.isDisabled})}dispose(){this._ltm.dispose()}_addBrowseMenuItem(e,s,t){const i=S(e.extension,e.assetTypeManifest.name,s),o=a.getFavoriteType({assetType:e,kind:s,diContainer:this._diContainer,assetTypeIdWithKind:i});if(!this.possibleFavoritesLookup[i.toLowerCase()]){this.possibleFavorites().push(o);const e=MsPortalFx.find(this._favoritesManager.favorites.value,(e=>e.id===o.id));e&&(o.isFavorite=e.isFavorite),this.possibleFavoritesLookup[o.id.toLowerCase()]=o}}_addBrowseMenuItemToCategory(e){const s=S(e.assetType.extension,e.assetType.assetTypeManifest.name,e.kind),t=a.getFavoriteType({assetType:e.assetType,kind:e.kind,diContainer:this._diContainer,assetTypeIdWithKind:s,boost:e.boost,subCategory:e.subCategory}),i=MsPortalFx.find(this._favoritesManager.favorites.value,(e=>e.id===t.id));if(i&&e.boost&&(i.boost=e.boost),!e.tempPossibleFavorites.some((e=>e.id===s))){const s=this.possibleFavoritesLookup[t.id.toLowerCase()];if(s){t.isFavorite=s.isFavorite,t.isFilteredOut=s.isFilteredOut,t.matches=s.matches,t.relevanceScore=s.relevanceScore;const i=t.isHidden=s.isHidden;i(i()||e.isHidden),e.boost&&(s.boost=e.boost)}e.tempPossibleFavorites.splice(e.index,0,t)}if(e.isHidden){const s=this.possibleFavorites().filter((e=>e.id===t.id))[0];s&&s.isHidden(e.isHidden)}}_loadFlyoutMenu(e){const s=this.possibleFavoritesLookup;this._assetTypes().forEach((s=>{this._addBrowseMenuItem(s,void 0,e)}));const t=this.categories();this.showCategories(!!t.length);const o=Object.keys(s).slice(0);t.forEach((e=>{const s=e.possibleFavorites;s();const t=e.sourceCategory,r=t&&t.items||[],a=[];r.length&&(r.forEach(((e,s)=>{let t,r,n=-1;if(this._assetTypes().some((i=>{if(function(e,s){return e.extensionName===s.extension&&e.assetType===s.assetTypeManifest.name}(e,i)){const o=(e.kind||"").toLowerCase();r=o&&i.kindMap&&i.kindMap[o]&&e.kind,n=s,t=i}return n>-1})),n>-1){r&&this._addBrowseMenuItem(t,r),MsPortalFx.remove(o,t.id.toLowerCase());const s=e.subCategoryId;let l=this._subCategoriesLocalizedNameMap[s];s&&!l&&(l=(0,i.provideSubCategoryName)(s),this._subCategoriesLocalizedNameMap[s]=l);const c={assetType:t,index:n,kind:r,isHidden:!!e.isHidden,tempPossibleFavorites:a,boost:e.boost,subCategory:l};this._addBrowseMenuItemToCategory(c)}})),s(a),e.count(a.filter((e=>!e.isHidden())).length))}));const a=this._uncuratedCategory,n=[];if(a){w(o.map((e=>s[e])),((e,s)=>(0,r.compareAssetTypeForSort)(e.label,s.label))).forEach((e=>{const s=e.assetType,t=this._extensionToDefaultCategoryMap[s.extension],i=t||a,o=!t&&1===this._discoveryPolicy||(0,d.supportsOption)(s.assetTypeManifest.options,1),r=this.possibleFavorites().filter((s=>s.id===e.id))[0];r&&r.isHidden(o);const l=i.possibleFavorites;let c=[];c=t?l():n;const p={assetType:s,index:c.length,kind:"",isHidden:o,tempPossibleFavorites:c};this._addBrowseMenuItemToCategory(p),l(c);const h=c.filter((e=>!e.isHidden())).length;i.count(h)}))}return this.possibleFavorites(w(this.possibleFavorites(),((e,s)=>(0,r.compareAssetTypeForSort)(e.label,s.label)))),Promise.resolve(this.categories())}};function A(e){const s=e.id;let{assetTypeManifest:t}=e.assetType;return e.kind&&e.assetType.kindMap&&(t=e.assetType.kindMap[e.kind.toLowerCase()]||t),"HubsExtension_BrowseAllResources"===s&&(t.marketplaceItemId="hub"),t}s.FavoritesManagerDeferred=B,s.FavoritesManagerDeferred=B=__decorate([__metadata("fx:diagnostics",[e,"FavoritesManagerDeferred"]),t.Class(),__metadata("design:paramtypes",[i.AssetTypeService,r.BrowseManager,a.FavoritesManager,t.Container,c.RecentServicesManager,b.Router])],B),s.getServiceBrowseDeepLink=async function(e,s){const t=e.id;let i;if(t.toLowerCase()===m.lowerCaseAllResourcesId)i=(0,m.getBrowseAllDeeplink)();else{i=await(0,m.getBrowseBladeUri)(s,t.toLowerCase())}return i||e.uri},s.getServiceAssetTypeManifest=A,s.getServiceCreateLink=function(e){const s=A(e);let t,i;return s.marketplaceItemId?t=`#create/${s.marketplaceItemId}`:s.noPdlCreateBlade&&(i=new y.ProvisioningBladeReference(s.noPdlCreateBlade,s.noPdlCreateExtension||e.assetType.extension)),{createLink:t,createBladeReference:i}}}));