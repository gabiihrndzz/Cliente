define("_generated/Less/MsPortalImpl/Widgets/Widgets.TeachingBubble.css",["module"],(function(e){"use strict";return{css:".fxs-teaching-bubble-layout{position:fixed;max-width:360px;z-index:1}.fxs-teaching-bubble-layout .fxs-button{display:flex;justify-content:center;align-items:center;height:32px;border-radius:2px}.fxs-teaching-bubble-layout .fxs-button-default{background-color:var(--colorButtonBackgroundPrimary);color:var(--colorButtonBackgroundSecondary);border-color:var(--colorButtonBackgroundSecondary)}.fxs-teaching-bubble-layout .fxs-portal-button-primary{background-color:var(--colorButtonBackgroundSecondary);color:var(--colorButtonBackgroundPrimary)}.fxs-teaching-bubble-layout .fxs-button-default:hover{color:var(--colorButtonBackgroundSecondary);background-color:var(--colorButtonBackgroundPrimaryHover)}.fxs-teaching-bubble-layout .fxs-portal-button-primary:hover{background-color:var(--colorButtonBackgroundSecondaryHover)}.fxs-teaching-bubble-button-container{display:flex;gap:10px;margin-left:auto}.fxs-teaching-bubble-container{box-sizing:border-box;white-space:normal}.fxs-teaching-bubble-triangle{box-shadow:3px 3px 7px lightgrey;position:absolute;background-color:var(--colorButtonBackgroundPrimary)}.fxs-teaching-bubble-content-container{position:relative;background-color:var(--colorButtonBackgroundPrimary);padding:20px 24px;color:var(--colorTextInverted)}.fxs-teaching-bubble-content-container a{color:var(--colorTextInverted);text-decoration:underline}.fxs-teaching-bubble-content-container a:hover{color:var(--colorTextInverted)}.fxs-teaching-bubble-title{font-size:20px;margin-bottom:14px;font-weight:600;display:flex;gap:10px}.fxs-teaching-bubble-title svg{height:16px;width:16px;fill:var(--colorButtonForegroundPrimary)}a.fxs-teaching-bubble-feedback-link.fxs-fxclick{color:var(--colorButtonForegroundPrimary)}a.fxs-teaching-bubble-feedback-link.fxs-fxclick :hover{color:var(--colorButtonForegroundPrimary)}.fxs-teaching-bubble-feedback-icon{width:16px;height:16px;margin-right:8px;display:inline-block;vertical-align:sub}.fxs-teaching-bubble-feedback-icon svg{fill:var(--colorButtonForegroundPrimary)}.fxs-teaching-bubble-footer{margin-top:14px;display:flex}.fxs-teaching-bubble-close{width:24px;height:24px;position:absolute;right:16px;top:8px;border:0;cursor:pointer}.fxs-teaching-bubble-close svg{fill:var(--colorButtonForegroundPrimary);padding:4px 8px}.fxs-teaching-bubble-close :focus{outline-color:var(--colorControlBackgroundSelected)}.fxs-teaching-bubble-close :hover{background-color:var(--colorButtonBackgroundPrimaryHover)}.fxs-teaching-bubble-content-container:not(:focus-within){opacity:.99;transition:opacity .01ms}.fxs-teaching-bubble-content-container:focus-within{opacity:1}.fxs-coachmark-circle{display:inline-block;background-color:var(--colorButtonBackgroundPrimary);border-radius:32px;width:32px;height:32px;position:relative;left:-11px}.fxs-coachmark-beak{fill:var(--colorButtonBackgroundPrimary);position:relative;top:-11px;transform:rotate(-90deg)}.fxs-coachmark-container{cursor:pointer;position:absolute;display:inline;z-index:1;transform:translateX(-16px)}@media screen and (forced-colors:active){.fxs-teaching-bubble-content-container{background-color:var(--colorHighContrastCanvas);color:var(--colorHighContrastCanvasText);box-shadow:inset 0 0 0 1px var(--colorHighContrastCanvasText)}.fxs-teaching-bubble-close svg{fill:var(--colorHighContrastButtonText)}.fxs-teaching-bubble-close :hover{background-color:inherit}.fxs-teaching-bubble-feedback-link{color:var(--colorHighContrastButtonText)}.fxs-teaching-bubble-feedback-link :hover{color:var(--colorHighContrastButtonText)}.fxs-teaching-bubble-feedback-icon{width:16px;height:16px;margin-right:8px;display:inline-block;vertical-align:sub}.fxs-teaching-bubble-feedback-icon svg{fill:var(--colorHighContrastButtonText)}.fxs-teaching-bubble-close:hover svg{fill:var(--colorHighContrastHighlightText)}.fxs-teaching-bubble-triangle{background-color:var(--colorHighContrastCanvas);box-shadow:inset 0 0 0 1px var(--colorHighContrastCanvasText)}.fxs-coachmark-beak{background-color:var(--colorHighContrastButtonText)}.fxs-coachmark-circle{background-color:var(--colorHighContrastButtonText)}}.fxs-teaching-bubble-feedback-container{padding-top:8px}",moduleId:e.id}})),
define("MsPortalImpl/Widgets/Widgets.TeachingBubble",["require","exports","MsPortalImpl/TsxStringMode/Tsx","MsPortalImpl/TsxStringMode/Tsx","MsPortalImpl/TsxStringMode/Tsx","Fx/Controls/Button","MsPortalImpl/Widgets/Widgets.WidgetBase","FxInternal/Css","_generated/Less/MsPortalImpl/Widgets/Widgets.TeachingBubble.css","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/UI/UI.BladeOpener","MsPortalImpl/UI/UI.DesktopManagerImpl","Fx/Composition/Selectable"],(function(e,t,i,n,s,o,a,r,l,d,c,h,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ensureElementInView=t.getTargetElement=t.createTeachingBubble=t.TeachingBubbleWidget=t.ViewModel=t.appearanceLink=void 0;var p=MsPortalFx.Base.Diagnostics.Telemetry;(0,r.injectCss)(l);const m=d.TeachingBubble;t.appearanceLink=i("a",{href:"#settings/appearance"},d.UiSettings.Flyout.appearanceAndStartupViewsTitle);let g=0;const f=`\n<div class="fxs-coachmark-container" title="${m.Coachmark.title}" data-bind="fxclick: hideCoachmark" aria-label="${m.Coachmark.coachmark}">\n    <svg height="10" width="18" class="fxs-coachmark-beak"><polygon points="9, 0 18, 10 0, 10"></polygon></svg>\n    <div class="fxs-coachmark-circle"></div>\n</div>\n`,b=i(s.Root,null,i(n.KoIf,{condition:"shouldShowCoachmark"},f),i(n.KoIfNot,{condition:"shouldShowCoachmark"},i("div",{class:"fxs-teaching-bubble-layout"},i("div",{class:"fxs-teaching-bubble-container"},i("span",{class:"fxs-teaching-bubble-triangle"}),i("div",{class:"fxs-teaching-bubble-content-container",tabindex:"-1","aria-label":m.container},i("div",{class:"fxs-teaching-bubble-title"},i(n.KoIf,{condition:"titleIcon"},i("span",{"data-bind":{image:"titleIcon"}})),i("span",{"data-bind":{text:"title"}})),i("span",{class:"fxs-teaching-bubble-description az-text-body","data-bind":{html:"description"}}),i(n.KoIf,{condition:"learnMoreLink"},"Â ",i("a",{class:"fxs-teaching-bubble-description fxs-teaching-bubble-learnmore-link",target:"_blank","data-bind":{attr:{href:"learnMoreLink"}}},m.learnmore)),i("div",{class:"fxs-teaching-bubble-footer"},i(n.KoIf,{condition:"showFeedbackButton"},'\n<div class="fxs-teaching-bubble-feedback-container">\n    <span data-bind="image: feedbackIcon" class="fxs-teaching-bubble-feedback-icon"></span>\n    <a role="link" class="fxs-teaching-bubble-feedback-link az-text-body" data-bind="text: feedbackText, fxclick: onFeedbackClick, attr: { \'aria-label\': ariaLabelText }"></a>\n</div>\n'),i(n.KoIf,{condition:"stepText"},i("div",{class:"fxs-teaching-bubble-step-text","data-bind":{text:"stepText"},style:"padding-top: 4px; margin-right: 4px;"})),i("div",{class:"fxs-teaching-bubble-button-container",style:"margin-left: auto;"},i(n.KoIf,{condition:"showPreviousButton"},i("div",{class:"fxs-teaching-bubble-prev-button","data-bind":{pcControl:"previousButton"}})),i("div",{class:"fxs-teaching-bubble-action-button","data-bind":{pcControl:"actionButton"}}),i(n.KoIf,{condition:"showDismissButton"},i("div",{class:"fxs-teaching-bubble-close-button","data-bind":{pcControl:"dismissButton"}})))))),i(n.KoIfNot,{condition:"showDismissButton"},i("button",{"data-bind":{fxclick:"onTeachingBubbleClose",image:"closeIcon"},"aria-label":m.close,class:"fxs-teaching-bubble-close"})))));class _ extends a.ViewModel{constructor(e){super(),this.options=e}}t.ViewModel=_;class x extends a.Widget{constructor(e,t){super(e,t),this._title=ko.observable(""),this._titleIcon=ko.observable(),this._showFeedbackButton=ko.observable(!1),this._description=ko.observable(""),this._learnMoreLink=ko.observable(""),this._currentStep=ko.observable(0),this._firedNextClickCallback=ko.observable(!1),this._openFeedbackLink=()=>{const e=this._diContainer.get(h.DesktopManagerImpl).getCurrentBladeInfo(),t={extensionName:e?.extensionName,bladeName:e?.bladeName,cesQuestion:m.Feedback.cESQuestion,cvaQuestion:m.Feedback.cVAQuestion,featureName:this._featureName,surveyId:this._surveyId||"DefaultTeachingBubbleSurvey"},i=new u.PdlBladeReference("InProductFeedbackBlade","HubsExtension",{parameters:t});this._diContainer.get(c.BladeOpener).openBlade(i,{flags:1,telemetryName:"InProductFeedbackBlade"}),this._onDeeplinkClick()},this._createFocusTrapZone=()=>{const e=$.querySelectorAll(".fxs-teaching-bubble-content-container")[0];e.focus(),e.addEventListener("transitionend",(()=>{e.focus()}))},this._onIFrameClick=()=>{"IFRAME"===document.activeElement.tagName&&this._dispose()},this._dispose=()=>{window.removeEventListener("click",this._clickHandler,!0),window.removeEventListener("blur",this._onIFrameClick),document.removeEventListener("scroll",this._onScrollOrResize,{capture:!0}),window.removeEventListener("resize",this._onScrollOrResize),window.removeEventListener("hashchange",this._onDeeplinkClick),this._wrapper.remove(),g=0,super.dispose()},this._clickHandler=e=>{if(!this._showCoachmark()&&this._options[this._currentStep()].onNextClickCallback&&this._firedNextClickCallback())return;const t=e.target===C(this._options[this._currentStep()].targetElement);this._wrapper.contains(e.target)||!this._dismissOnTargetClick&&t||(this._onDismiss?.("clickedAway",t),this._dispose())},this._onScrollOrResize=()=>{this._onDismiss?.("scrollOrResize"),this._dispose()},this._onDeeplinkClick=()=>{this._onCompletion?.(),this._dispose()};const{onDismiss:i,onCompletion:n,isCoachmark:s,diContainer:a,featureName:r,dismissOnTargetClick:l,hasTourContinuation:d,onCoachmarkExpanded:f,surveyId:_}=t.options;this._options=t.options.teachingBubbleOptions,this._showCoachmark=ko.observable(s),this._featureName=r,this._surveyId=_,this._dismissOnTargetClick=l;const x=document.getElementById("teaching-bubble-wrapper"+g),y=C(this._options[0].targetElement);if(x||!y)return;this._diContainer=a,this._currentStep=ko.observable(0);const I=this._options.length,w=I-1;this._stepText=ko.pureComputed((()=>this._options.length>1?m.stepText.format(this._currentStep()+1,I):"")),this._onDismiss=i,this._onCompletion=n;const v=this.ltm;if(this._wrapper=x||document.createElement("div"),this._wrapper.setAttribute("id","teaching-bubble-wrapper"+g++),this._wrapper.innerHTML=b,document.body.prepend(this._wrapper),s){const e=2;let t=this._options[0].directionalHint||"left";const i=y.getBoundingClientRect(),n=document.getElementsByClassName("fxs-coachmark-container")[0],s=n.getBoundingClientRect(),o=window.innerHeight-i.bottom-s.height>0,a=i.top-window.scrollY-s.height>0,r=window.innerWidth-i.right-s.width>0,l=window.scrollX+i.left-s.width>0;t=this._getBestDirectionalHint(t,o,a,r,l),"left"===t?(n.style.top=i.top+(i.height-s.height)/2+e+"px",n.style.left=i.right+s.height/2-e+"px"):"up"===t?(n.style.transform="translateX(50%) rotate(90deg)",n.style.top=i.bottom+e+"px",n.style.left=i.left+i.width/2-s.width-e+"px"):"right"===t?(n.style.transform="rotate(180deg)",n.style.top=i.top+(i.height-s.height)/2-e+"px",n.style.left=i.left-s.width+"px"):"down"===t&&(n.style.transform="translateX(50%) rotate(270deg)",n.style.top=i.top-s.height-e+"px",n.style.left=i.left+i.width/2-s.width+"px")}else this._applyTeachingbubble(this._currentStep()),this._createFocusTrapZone();this.actionButton=o.create(v,{text:ko.pureComputed((()=>this._currentStep()===w?this._options[w].actionButtonText||m.finish:m.next)),style:0,onClick:()=>{if(this._currentStep()===w)!d&&n?.(),this._dispose();else{const e=this._currentStep()+1,{onNextClickCallback:t}=this._options[this._currentStep()],i=()=>{this._currentStep(e),this._applyTeachingbubble(e),this._firedNextClickCallback(!1)};t?(t(),this._firedNextClickCallback(!0),setTimeout(i,0)):i()}}}),this.dismissButton=o.create(v,{text:m.Button.maybeLater,style:1,onClick:()=>{this._onDismiss?.("dismissButton"),this._dispose()}});const M=o.create(v,{text:m.previous,style:1,onClick:()=>{const e=this._currentStep()-1;this._currentStep(e),this._applyTeachingbubble(e)}}),P={title:this._title,titleIcon:this._titleIcon,description:this._description,learnMoreLink:this._learnMoreLink,showFeedbackButton:this._showFeedbackButton,actionButton:this.actionButton,dismissButton:this.dismissButton,previousButton:M,showDismissButton:ko.pureComputed((()=>this._options[this._currentStep()].showDismissButton)),showPreviousButton:ko.pureComputed((()=>this._currentStep()>0)),stepText:this._stepText,shouldShowCoachmark:this._showCoachmark,feedbackText:m.Feedback.giveFeedback,ariaLabelText:m.Feedback.giveFeedback,hideCoachmark:()=>{this._showCoachmark(!1),this._applyTeachingbubble(this._currentStep()),this._createFocusTrapZone(),f?.();const{extension:e,bladeName:t,targetElement:i}=this._options[this._currentStep()];p.trace({action:"coachmarkExpanded",source:"TourGuide",data:{extension:e,blade:t,target:i}})},closeIcon:MsPortalFx.Base.Images.Close(),disabled:ko.observable(!1),feedbackIcon:MsPortalFx.Base.Images.Feedback(),onFeedbackClick:()=>{this._openFeedbackLink()},onTeachingBubbleClose:()=>{this._onDismiss?.("closeButton"),this._dispose()}};window.addEventListener("click",this._clickHandler,!0),window.addEventListener("blur",this._onIFrameClick),window.addEventListener("hashchange",this._onDeeplinkClick),document.addEventListener("scroll",this._onScrollOrResize,{once:!0,capture:!0}),window.addEventListener("resize",this._onScrollOrResize,{once:!0}),ko.applyBindings(P,this._wrapper)}_getBestDirectionalHint(e,t,i,n,s){const o={up:{canPoint:t,alternates:["down","left","right"]},down:{canPoint:i,alternates:["up","left","right"]},left:{canPoint:n,alternates:["right","up","down"]},right:{canPoint:s,alternates:["left","up","down"]}};if(o[e]&&!o[e].canPoint)for(const t of o[e].alternates)if(o[t].canPoint)return t;return e}_positionTeachingBubble(e,t,i,n,s,o){"left"===n?(i.style.transform=`translate(-50%, ${(t.clientHeight-i.clientHeight)/2}px) rotate(45deg)`,t.style.top=e.top+e.height/2-t.clientHeight/2+(this._options[this._currentStep()].verticalOffset||0)+"px",t.style.left=e.right+s/2+(this._options[this._currentStep()].horizontalOffset||0)+"px"):"up"===n?(t.style.top=e.bottom+s/2+(this._options[this._currentStep()].verticalOffset||0)+"px",t.style.left=e.left+e.width/2-t.clientWidth/2+(this._options[this._currentStep()].horizontalOffset||0)+"px",i.style.transform=`translate(${(t.clientWidth-i.clientWidth)/2}px, -50%) rotate(45deg)`):"right"===n?(t.style.top=e.top+e.height/2-t.clientHeight/2+(this._options[this._currentStep()].verticalOffset||0)+"px",t.style.left=e.left-t.clientWidth-i.clientWidth+(this._options[this._currentStep()].horizontalOffset||0)+"px",i.style.left=t.clientWidth-s/2+"px",i.style.transform=`translate(15%, ${(t.clientHeight-o)/2}px) rotate(45deg)`):"down"===n&&(t.style.top=e.top-t.clientHeight-s/2+(this._options[this._currentStep()].verticalOffset||0)+"px",t.style.left=e.left+e.width/2-t.clientWidth/2+(this._options[this._currentStep()].horizontalOffset||0)+"px",i.style.transform=`translate(${(t.clientWidth-i.clientWidth)/2}px, 15%) rotate(45deg)`,i.style.top=t.clientHeight-s/2+"px")}_applyTeachingbubble(e){const t=this._options[e],i=C(t.targetElement),n=document.getElementsByClassName("fxs-teaching-bubble-layout")[0],s=document.getElementsByClassName("fxs-teaching-bubble-triangle")[0];if(i&&n&&s){this._title(t.title),this._description(t.description),this._learnMoreLink(t.learnMoreLink),this._titleIcon(t.titleIcon),this._showFeedbackButton(t.showFeedbackButton);const o=i.getBoundingClientRect();t.width&&(n.style.width=t.width+"px");const a=16,r=a*Math.sqrt(2);s.style.width=a+"px",s.style.height=a+"px",s.style.top="0px",s.style.left="0px";let l=t.directionalHint||"left";const d=o.top-window.scrollY-n.clientHeight>0&&o.left+o.width/2-n.clientWidth/2>window.scrollX,c=window.innerHeight-o.bottom-n.clientHeight>0&&o.left+o.width/2-n.clientWidth/2>window.scrollX,h=window.scrollX+o.left-n.clientWidth>0&&o.bottom-n.clientHeight/2>window.scrollY,u=window.innerWidth-o.right-n.clientWidth>0&&o.bottom-n.clientHeight/2>window.scrollY;l=this._getBestDirectionalHint(l,c,d,u,h),this._positionTeachingBubble(o,n,s,l,r,a),e&&n.getElementsByClassName("fxs-button-default")[0].blur()}}}function C(e){if("string"==typeof e){const t=document.querySelector(".fxs-blade-lastblade");return t?t.querySelector(e):document.querySelector(e)}return e}t.TeachingBubbleWidget=x,t.createTeachingBubble=function(e){const t=new _(e);return new x($(document),t)},t.getTargetElement=C,t.ensureElementInView=function(e){const t=e.getBoundingClientRect();t.top>=0&&t.left>=0&&t.right<=window.innerWidth&&t.bottom<=window.innerHeight||e.scrollIntoView()}})),
define("MsPortalImpl/Services/Services.TourGuideManager",["require","exports","Fx/DependencyInjection","MsPortalImpl/Widgets/Widgets.TeachingBubble","MsPortalImpl/Services/Services.Settings","MsPortalImpl/Services/Services.AssetTypes","FxInternal/Weave","MsPortalImpl/Services/Services.GeneralSettings","MsPortalImpl/UI/Compositions/UI.Composition.BladeHistory","MsPortalImpl/Extension/ExtensionManagerOptions","MsPortalImpl/Extension/Extension.Manifest","MsPortalFx/Globalization","MsPortalImpl/UI/Compositions/UI.Composition","Fx/Ajax","Fx/Experimentation"],(function(e,t,i,n,s,o,a,r,l,d,c,h,u,p,m){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TourGuideManager=void 0;var g=MsPortalFx.Base,f=MsPortalFx.Errors,b=MsPortalFx.Base.Diagnostics.Telemetry;const _={acknowledged:!1,dismissCount:0,expirationDate:""},x=g.Diagnostics.createLog(e),C="HubsExtension",y=e=>e.builtIn?{blade:"ResourceMenuBlade",extension:C,resourceType:e.resourceType}:e,I=e=>{let t=0;return new Promise(((i,n)=>{const s=e=>{t++;const o=document.querySelector(".fxs-blade-lastblade"),a=o?o.querySelector(e):document.querySelector(e);if(a&&(e=>{const{getComputedStyle:t}=e.ownerDocument.defaultView,{display:i,visibility:n,opacity:s}=t(e),o="none"!==i&&"hidden"!==n&&"collapse"!==n&&"0"!==s,a=e.getBoundingClientRect(),r=a.top>=0&&a.left>=0&&a.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&a.right<=(window.innerWidth||document.documentElement.clientWidth);return o&&r})(a))i(a);else{if(t>=10)return void n(new Error(`Timeout waiting for ${e}`));setTimeout((()=>{s(e)}),500)}};s(e)}))},w=e=>`${e}-tours`,v=(e,t)=>e===C&&"ResourceMenuBlade"===t;let M=class{constructor(e,t,i,n,s){this._settingsManager=e,this._assetTypeService=t,this._extensionManagerOptions=i,this._manifestCache=n,this._diContainer=s,this._storeData=new Map,this._metadataCache={},this._activeTours=new Map,this._activatedToursCount=0,this.setTourGuideActivatedToursCount=e=>{this._activatedToursCount=e},this._getActiveTours=(e,t)=>{const i=w(e),n=this._activeTours.get(i);if(n)return n.filter((e=>e.bladeName===t))},this._saveActiveTour=(e,t,i,n,s,o)=>{const a=w(e),r=this._activeTours.get(a)||[];r.find((e=>e.tourId===t))||r.push({tourId:t,bladeName:i.bladeName,content:n,expirationDate:s,experiment:o}),this._activeTours.set(a,r)},this._checkTourContinuation=(e,t,i)=>{let n,s=e.content,o=!1;if(t>-1){o=!0;const a=e.content.slice(t);s=e.content.slice(0,t),i?n=()=>{this._saveActiveTour(a[0].extension,e.tourId,a[0],a,e.expirationDate,e.experiment),this.setTourGuideActivatedToursCount(this._activatedToursCount+1)}:this._saveActiveTour(a[0].extension,e.tourId,a[0],a,e.expirationDate,e.experiment)}return{tourDataToShow:s,hasTourContinuation:o,onCoachmarkExpanded:n}};const o=this._diContainer.get(FxImpl.Features),l=(0,a.toComputation)(this._diContainer.get(r.GeneralSettings).notificationTeachingBubbleEnabledKey);if(!this._addedListener&&!o.isEnabled("ci")&&l){this._addedListener=!0;const e=e=>{const{extensionName:t,bladeName:i}=e.detail;this._startTour(t,i)};window.addEventListener("fxtriggertourguide",e),this._alwaysShowTours=o.isEnabled("alwaysShowTours")}}displayTour(e){const{tourData:t,expirationDate:i,extension:s,tourId:o,hasTourContinuation:a,onCoachmarkExpanded:r,surveyId:l,isCoachmark:d}=e,c=(0,n.getTargetElement)(t[0].targetElement),h=`${s} tour - ${o}`,u={teachingBubbleOptions:t,onCompletion:()=>{this._onInteraction(s,o,i,"acknowledge","")},onDismiss:(e="",t=!1)=>{this._onInteraction(s,o,i,"dismiss",e,t)},isCoachmark:d??!0,diContainer:this._diContainer,featureName:this._featureName,surveyId:l,hasTourContinuation:a,onCoachmarkExpanded:r};try{c?((0,n.ensureElementInView)(c),(0,n.createTeachingBubble)(u),b.trace({action:"displayed",source:"TourGuide",name:h})):b.trace({action:"failedDisplay",source:"TourGuide",name:h})}catch(e){b.trace({action:"errorDisplay",source:"TourGuide",name:h,data:e})}}async checkTourSettings(e,t,i,n=3,s){if(new Date(i)<new Date)return!1;await this._getTourGuideStoreData(e,t,s);const o=this._storeData.get(e);if(o&&o.tours?.[t]){const e=o.tours[t]?.acknowledged||!1,i=o.tours[t]?.dismissCount||0;return!e&&i<n}return!0}async readTourGuideSetting(e){return this._settingsManager.querySetting(23,e,!0)}writeTourGuideSetting(e,t){this._settingsManager.setSetting(23,e,t)}getTourGuideActiveTours(e){return this._activeTours.get(e)}setTourGuideActiveTours(e,t){this._activeTours.set(e,t)}_matchesCurrentBladeAndExtension(e,t,i){return t===C?y(e).blade===i:(e.builtIn||v(e.extension,e.blade))&&document.querySelector(".fxc-menu")?e.resourceType===this._getResourceType("ResourceMenuBlade"):e.extension===t&&e.blade===i}async _getTourStepForCurrentBlade(e,t,i){const n=await this._diContainer.get(m.Experimentation).shellAssignments.whenAvailable(),s=e=>!e.experiment||n.getBooleanValue(e.experiment),o=this._getActiveTours(t,i);if(o?.length)return o.filter(s);{const n={},o={},a=e.filter((e=>{if(s(e)){let s=!1,a=!1;const r=e.steps[0];if(s=Array.isArray(r.blade)?r.blade.some(((s,o)=>{if(this._matchesCurrentBladeAndExtension(s,t,i))return n[e.id]=o,!0})):this._matchesCurrentBladeAndExtension(r.blade,t,i),!s&&e.steps.length>1){const s=e.steps.findIndex(((s,o)=>{if(0!==o&&s.canStartTour)return Array.isArray(s.blade)?s.blade.some(((s,o)=>{if(this._matchesCurrentBladeAndExtension(s,t,i))return n[e.id]=o,!0})):this._matchesCurrentBladeAndExtension(s.blade,t,i)}));-1!==s&&(a=!0,o[e.id]=s)}return s||a}}));if(a.length>0)return a.map((e=>{const t=n[e.id],i=e.id in o?e.steps.slice(o[e.id]):e.steps,s=i[0],a=i.length-1,r=Array.isArray(s.blade),l=y(r?s.blade[t]:s.blade),d=l.blade,c=l.extension,h=r?s.targetElement.cssSelector[d]:s.targetElement.cssSelector;return{tourId:e.id,bladeName:d,content:i.map(((e,t)=>({...e.content,targetElement:0===t?h:e.targetElement.cssSelector,extension:0===t?c:y(e.blade).extension,bladeName:0===t?d:y(e.blade).blade,directionalHint:e.content.directionalHint||"left",showFeedbackButton:t===a}))),expirationDate:e.expirationDate}}))}}_checkAndDisplayTour(e,t,i,n,s){const o=((e,t,i)=>{for(let n=0;n<i.length;n++){const s=i[n];if(!v(s.extension,s.bladeName)&&(s.extension&&s.extension!==e||s.bladeName&&s.bladeName!==t))return n}return-1})(e,t,i.content),{tourDataToShow:a,hasTourContinuation:r,onCoachmarkExpanded:l}=this._checkTourContinuation(i,o,n),d=()=>{l?l():this.setTourGuideActivatedToursCount(this._activatedToursCount+1)},c=i.content[0];I(c.targetElement).then((t=>{this.displayTour({extension:e,tourId:i.tourId,tourData:a,expirationDate:i.expirationDate,hasTourContinuation:r,onCoachmarkExpanded:d,surveyId:"TourGuideSurvey"})})).catch((i=>{b.trace({action:"targetTimeout",source:"TourGuide",data:{extension:e,blade:t,target:c.targetElement,tourId:s}})}))}async _filterTours(e,t){const i=e.map((e=>this.checkTourSettings(t,e.tourId,e.expirationDate))),n=await Promise.all(i);return e.filter(((e,t)=>this._alwaysShowTours||n[t])).sort(((e,t)=>new Date(e.expirationDate).getTime()-new Date(t.expirationDate).getTime())).slice(0,3)}async _loadExtensionTours(e,t){const i=await this._manifestCache.getManifestAsync(e,"tourGuide"),n=i?.tourIds;if(n?.length>0){const i=await this._fetchTourMetadata(e,n),s=await this._getTourStepForCurrentBlade(i,e,t);if(s?.length){const i=await this._filterTours(s,e);if(this._filteredTours=i,i?.length)if((e=>e.toLowerCase().endsWith(".ReactView".toLowerCase()))(t)){const e=(()=>{const e=$.querySelectorAll(".fxs-portal-content .fxs-blade .fxs-blade-content-container .fxs-tile");if(e.length>0){const t=e.last()[0];return $.data(t,u.CompositionInstanceDataName)}})();(e?._part).showTours(i,this._storeData,this._activatedToursCount)}else this.displayKOToursSequentially(0,i,e)}}}displayKOToursSequentially(e,t,i){if(e>=t.length||this._activatedToursCount>5)return;const n=t[e];this._sequentialTourIndex=e,this._checkAndDisplayTour(i,n.bladeName,n,!0,n.tourId)}_getResourceType(e){let t;const i=window.location.hash,n=decodeURIComponent(i).split("/");if("BrowseResource"===e||"Browse.ReactView"===e){const e=n.indexOf("resourceType");if(-1!==e)t=n.slice(e+1,e+3).join("/");else{const e=n.indexOf("#browse");t=-1!==e?n.slice(e+1,e+3).join("/"):""}}else if("ResourceMenuBlade"===e){const e=n.indexOf("providers");t=-1!==e?n.slice(e+1,e+3).join("/"):""}else if("ARGBrowseResourcesInMenu"===e){const e=this._diContainer.get(l.BladeHistory).getEntries();t=e[0]?.bladeReference?.parameters?.resourceType}return t}_startTour(e,t){if(this._activatedToursCount<5){let i=e;if(e===C){this._loadExtensionTours(e,t);const n=this._getResourceType(t),s=this._assetTypeService.getAssetTypeByResourceType(n);i=s?.extension}i&&i!==C&&this._loadExtensionTours(i,t)}}async _fetchTourMetadata(e,t){const{displayLanguage:i}=h,n=`${e}-${i}`;if(this._metadataCache[n])return this._metadataCache[n];const s=(e=>{const t=MsPortalEarly.ExtensionLoader.getUri(e);return MsPortalFx.pathJoin("/",t,"Content")})(this._extensionManagerOptions.getNormalizedMetadata(e,!0)),o=t.map((e=>(0,p.ajax)({uri:MsPortalFx.pathJoin("/",s,"Dx","TourGuide",i,`${e}.TourGuide.json`),useRawAjax:!0})));let a;try{a=(await Promise.all(o)).map((e=>e.tourGuide))}catch(t){throw b.trace({source:"TourGuideManager",action:"CannotLoadTourMetadata",actionModifier:b.ActionModifier.Mark,data:{extensionUri:s,content:e,status:t?.jqXHR?.status}}),t}return this._metadataCache[n]=a,a}async _getTourGuideStoreData(e,t,i){try{if(!this._storeData.has(e)||i){let i=await this._settingsManager.querySetting(23,e,!0);i&&i.tours?this._cleanExtensionTourData(e,i):i=this._getDefaultExtensionTourData(t),this._storeData.set(e,i)}}catch(i){x.warning(new f.Error({message:`Failed to retrieve Tour Guide store data for ${e}`,innerErrors:[i]})),this._storeData.set(e,this._getDefaultExtensionTourData(t))}}_getDefaultExtensionTourData(e){const t={lastCleanDate:"",tours:{}};return t.tours[e]={..._},t}_cleanExtensionTourData(e,t){if(!t.lastCleanDate)return t.lastCleanDate=(new Date).toLocaleDateString(),t.tours||(t.tours={}),void this._settingsManager.setSetting(23,e,t);const i=new Date(t.lastCleanDate),n=new Date;if(Math.floor((n.getTime()-i.getTime())/864e5)>=30){const i=Object.keys(t.tours);for(const e of i){new Date(t.tours[e].expirationDate)<n&&delete t.tours[e]}t.lastCleanDate=n.toLocaleDateString(),this._settingsManager.setSetting(23,e,t)}}async _onInteraction(e,t,i,n,s,o){try{let a=this._storeData.get(e)||await this._settingsManager.querySetting(23,e);a||(a=this._getDefaultExtensionTourData(t));const r=a.tours[t]||{..._};let{acknowledged:l,dismissCount:d}=r;const{lastCleanDate:c}=a;"acknowledge"===n?l=!0:o||(d+=1);const h={acknowledged:l,dismissCount:d,expirationDate:i},u={lastCleanDate:c,tours:{...a.tours,[t]:h}};if(this._storeData.set(e,u),this._settingsManager.setSetting(23,e,u),l||d>=3){const i=w(e),n=this._activeTours.get(i);if(n?.length>0){const e=n.filter((e=>e.tourId!==t));this._activeTours.set(i,e)}}"acknowledge"===n&&void 0!==this._sequentialTourIndex&&this._filteredTours&&this.displayKOToursSequentially(this._sequentialTourIndex+1,this._filteredTours,e),b.trace({action:o?"targetClicked":n,actionModifier:s,source:"TourGuide",name:`${e} tour - ${t}`})}catch(e){x.warning(new f.Error({message:`Failed to update Tour Guide store on ${n}`,innerErrors:[e]}))}}};t.TourGuideManager=M,t.TourGuideManager=M=__decorate([__metadata("fx:diagnostics",[e,"TourGuideManager"]),i.Class(),__metadata("design:paramtypes",[s.SettingsManager,o.AssetTypeService,d.ExtensionManagerOptions,c.ManifestCache,i.Container])],M)})),
define("MsPortalImpl/UI/Commands/UI.CommandBarManager",["require","exports","FxInternal/Composition/ViewModel","MsPortalImpl/Base/Base.ImplUtils","MsPortalImpl/Extension/DefinitionCache","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","MsPortalImpl/Widgets/Widgets.CommandBar","MsPortalImpl/UI/Compositions/UI.Composition.Selectable2Registrar","MsPortalImpl/Base/Base.Selectable2"],(function(e,t,i,n,s,o,a,r,l,d){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.create=void 0;MsPortalFx.Base.Diagnostics;const c=MsPortalFx.disposeDisposable;t.create=function(t,h,u,p){const m=ko.observable([]),g=ko.observable([]);return t.registerForDispose((()=>{m().forEach(c),g().forEach(c)})),o.getCommandGroupForDefinitionItem(u.get(s.DefinitionCache),h.extension.name,h.bladeDefinition).then((s=>{s?function(e,t,i,n,s,a){const l=t.widget,d=[],c=n.commands.map((n=>{const a=new o.ExtensionCommandMenuItemImpl(e,t.extension,t,n,t.bladeDefinition,i,s);return a.activate(),d.push(a),new r.PdlCommandButton(e,a)})),h=l.options.contextMenu.menuItems;h.push.apply(h,d),l.options.commandBar.menuItems(d),a(c)}(t,h,u,s,p,m):function(t,s,o,r){const c=s.bladeDefinition.toolbar,h=c?c.source.valuesFrom[0]:null;if(h){const o=MsPortalFx.find(MsPortalFx.mapMany(s.children,(e=>e.children)),(e=>e.locator.name===h.part));let c;const u=ko.observable(!0);s.uiBlockers.push(u),o.await(6).then((()=>{const u=o.getViewModel(0),p=a.getModelValue(u,h.property);if(p.exists){d.setSelectableContext(t.createChildLifetime(),u,s.widget.element),s.widget.options.renderCmdBarWhenNoCmd(!0);const e=p.value.items;MsPortalFx.isObservableArray(e)?e.subscribeAndRun(t,(e=>{(0,l.registerOpenBladeCommands)(e,u,o,"commandBar2Selectables",void 0)?r(e):r([])})):c="Invalid view model for the toolbar at '{0}' in part '{1}'. It is missing the items property"}else i.isV2(u.content())||(c="Unable to find the view model for the toolbar at '{0}' in part '{1}'.");if(c){c=c.format(h.property,o.locator.toFriendlyString());const t=FxImpl.createError(c);(0,n.logToExtension)(e,o.extension.name,2,t)}})).finally((()=>u(!1)))}}(t,h,0,g),ko.reactor(t,(()=>{const e=s?m():g();h.widget.options.commandBar.items(e.slice())}))}))}})),
define("MsPortalImpl/UI/Commands/UI.Commands.Blade",["require","exports","FxInternal/AsyncLoader","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Commands/UI.ShellCommands"],(function(e,t,i,n,s,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResetLayout=t.setDisplayStateCommands=t.getDisplayStateCommand=t.BladeDisplayStateCommand=t.Edit=t.Pin=void 0;var a=MsPortalFx.Base.Images,r=MsPortalFx.Blades.Internal.DisplayState;const l=n.ShellCommands;class d extends o.ShellCommand{constructor(e,t){super(e,t,o.CommandNames.PinBlade,{text:l.pinToStartboard,icon:a.Pin()})}execute(e){return this._getComposition().getPinOptions().then((e=>i.get("MsPortalImpl/UI/Dashboard/Common/DashboardPinHelper","pinTilesWithDashboardSelection").then((t=>t(this._diContainer,"Blade",e))))).finally((()=>{super.execute(e)}))}}t.Pin=d;class c extends o.ShellCommand{constructor(e,t,i){super(e,t,o.CommandNames.EditBlade,{text:l.editBlade,icon:a.Edit()}),this._lifetimeManager=e,this._onModeChanged=i}async execute(e){if(!this._editor){const e=await MsPortalFx.require("MsPortalImpl/UI/Dx/UI.Editor");this._editor=new e.Editor(this._diContainer),this._lifetimeManager.registerForDispose(this._editor)}if(this._editing)this._editor.save();else{const e=this._getComposition();this._editor.injectIntoBlade(e)}this._changeMode(!this._editing),super.execute(e)}reset(){this._editor&&(this._changeMode(!1),this._editor.disableRegions())}_changeMode(e){this._editing=e,this._onModeChanged(e)}}t.Edit=c;class h extends o.ShellCommand{constructor(e,t,i,n){super(e,t,o.CommandNames.BladeDisplayState+r[n],{text:i}),this.targetState=n}execute(e){const t=(0,s.getBladeContainerWidget)($(this._currentContext.target));t&&t.options.displayState(this.targetState),super.execute(e)}bind(e){const t=(0,s.getBladeContainerWidget)($(e.target));super.bind(e),this.enabled(t&&this.targetState===t.options.displayState())}}let u;t.BladeDisplayStateCommand=h;let p;t.getDisplayStateCommand=function(e,t){return p||(u=u||new FxImpl.TriggerableLifetimeManager,p=[],p[1]=new h(u,e,l.bladeRestore,1),p[2]=new h(u,e,l.bladeMaximize,2)),p[t]},t.setDisplayStateCommands=function(e){p&&(u&&u.dispose(),p=null),p=e};class m extends o.ShellCommand{constructor(e,t,i,n){super(e,t,o.CommandNames.ResetLayout,{text:l.resetLayout,icon:a.Refresh(),enabled:!0!==i}),this.bind=e=>{super.bind(e),this.enabled(!0!==i&&0!==n())}}execute(e){this._getComposition().resetLayout(),super.execute(e)}bind(e){}}t.ResetLayout=m})),
define("MsPortalImpl/UI/Compositions/UI.Composition.Blade.Tours",["require","exports","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/TsxStringMode/Tsx"],(function(e,t,i,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getCollapsibleMenuTourOptions=void 0;const s=i.TeachingBubble,o="HubsExtension",a=n("a",{href:"#settings/appearance"},i.UiSettings.Flyout.appearanceAndStartupViewsTitle);t.getCollapsibleMenuTourOptions=e=>{const t=[{targetElement:$.querySelectorAll(".fxs-blade-display-in-journey .azc-listView-group button.azc-listView-collapsible-groupheader")[1],directionalHint:"left",title:s.CollapsibleMenu.title,description:s.CollapsibleMenu.description.format(n("br",null),n("br",null),a),showFeedbackButton:!0,extension:o}];return{extension:o,tourId:"UpdatedCollapsibleMenuSettings",tourData:t,expirationDate:e,hasTourContinuation:!1,surveyId:"MenuCollapseTB",isCoachmark:!1}}})),
define("MsPortalImpl/UI/Compositions/UI.Composition.Lens",["require","exports","MsPortalImpl/Extension/Extension.Definition.Locator","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/UI/Compositions/UI.Composition.Base","MsPortalImpl/UI/Compositions/UI.Composition.Part","MsPortalImpl/Widgets/Widgets.Lens"],(function(e,t,i,n,s,o,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.create=t.Instance=void 0;var r=MsPortalFx.Base.Diagnostics,l=n.CompositionType;const d=r.createLog(e);class c extends s.Instance{constructor(e,t,n,s,o,a){super("Lens",e,t,n,s,o,a),this._childOnInputsSetsResolved=Promise.withResolvers(),this._finder=e.get(i.DefinitionFinder)}awaitChildrenOnInputsSetsResolved(){return this._childOnInputsSetsResolved.promise}getCompositionType(){return l.Lens}_compose(e,t){const i=Promise.resolve({}),n=function(e,t){const i=t.locate(e.locator);return i&&i.isSummary}(this,this._finder),s=new a.ViewModel(this.id,this.diContainer);ko.computed(this,(function(){s.locked(e.options.locked())}));const o=$(FxImpl.createElement("div",{class:n?"fxs-portal-border":""}));if(this.widget=new a.Widget(o,s),n?(s.locked(!0),e.setSummary(o)):e.addChild(this.widget),this._finder.locateAsync(this.locator.getExtensionLocator()).then((e=>{const t=this._finder.locate(this.locator);if(t&&t.title){const i=t.title;i?s.title(i):d.error("Lens {0} in extension {1} is missing title.".format(this.locator.toString(),e.name))}})),this.children){const e=this.children.slice();Promise.allSettled(e.map((e=>{const t=e.await(3);return e.compose(this.widget),t}))).finally((()=>{this._childOnInputsSetsResolved.resolve()})),this.save(),i.then((()=>{t.resolve()}))}}}t.Instance=c,t.create=function(e,t,n){const s=e.get(i.DefinitionFinder).locate(t),a=new c(e,t,null,null,null,n);if(s&&s.partInstances){const i=[];s.partInstances.forEach((s=>{const a=o.create(e,t.withPartInstance(s.name),null,null,null,n);i.push(a)})),a.addChildren(i)}return a}})),
define("MsPortalImpl/UI/Compositions/UI.Composition.ShareResource",["require","exports","Fx/DependencyInjection","MsPortalImpl/UI/UI.BladeOpener","Fx/Composition/Selectable"],(function(e,t,i,n,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ShareResource=void 0;let o=class{constructor(e){this._bladeOpener=e}openContextPane(e,t){const i=new s.PdlBladeReference("ShareIt.ReactView","Microsoft_Azure_AD",{parameters:{resourceId:e,portalUri:MsPortalFx.portalUri}}),n={flags:1,telemetryName:t};return this._bladeOpener.openBlade(i,n)}};t.ShareResource=o,t.ShareResource=o=__decorate([__metadata("fx:diagnostics",[e,"ShareResource"]),i.Class(),__metadata("design:paramtypes",[n.BladeOpener])],o)})),
define("MsPortalImpl/UI/Compositions/UI.Composition.Blade",["require","exports","Fx","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/Base/Base.ImplUtils","MsPortalImpl/Base/Telemetry","MsPortalImpl/Base/Base.DeepLink","MsPortalImpl/Base/Base.HistoryManager","FxInternal/Controls/Notice","Fx/Experimentation","MsPortalImpl/Extension/Extension.Definition.Locator","MsPortalImpl/Extension/Extension.Manifest","MsPortalImpl/Extension/ViewModelManager","MsPortalImpl/Interactions/Interactions.FocusHandler","MsPortalImpl/Interactions/Interactions.PortalReader","MsPortalImpl/Services/Services.AssetTypes","MsPortalImpl/Services/Services.EditScopeManagement","MsPortalImpl/Services/Services.TourGuideManager","MsPortalImpl/UI/UI.DeepLink","MsPortalImpl/UI/UI.DialogManager","MsPortalImpl/Widgets/Widgets.Blade","MsPortalImpl/Widgets/Widgets.BladeContent","MsPortalImpl/Widgets/Widgets.PartError","MsPortalImpl/Widgets/Widgets.UIElementBase","MsPortalImpl/UI/Commands/UI.CommandBarManager","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Commands/UI.Commands.Blade","MsPortalImpl/UI/Commands/UI.ShellCommands","MsPortalImpl/UI/UI.DesktopManager","MsPortalImpl/UI/UI.JourneyManager","MsPortalImpl/UI/Compositions/UI.Composition.Blade.Tours","MsPortalImpl/UI/Compositions/UI.Composition.ShareResource","FxInternal/Utils/Promise","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/UI/Compositions/UI.Composition.Base","MsPortalImpl/UI/Compositions/UI.Composition.BladeHistory","MsPortalImpl/UI/Compositions/UI.Composition.BladeOpener.Helpers","MsPortalImpl/UI/Compositions/UI.Composition.BladeTelemetry","MsPortalImpl/UI/Compositions/UI.Composition.CompositionAwaiter","MsPortalImpl/UI/Compositions/UI.Composition.CompositionBinder","MsPortalImpl/UI/Compositions/UI.Composition.Finder","MsPortalImpl/UI/Compositions/UI.Composition.Lens","MsPortalImpl/UI/Compositions/UI.Composition.Part","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","MsPortalImpl/UI/Compositions/UI.Composition.Security","MsPortalImpl/Widgets/Widgets.Portal.init"],(function(e,t,i,n,s,o,a,r,l,d,c,h,u,p,m,g,f,b,_,x,C,y,I,w,v,M,P,B,S,D,T,k,E,F,R,A,V,L,U,W,O,N,H,j,z,q){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Instance=t.create=void 0;var G=FxImpl.TelemetryContext,K=G.ContextType,J=MsPortalFx.Base,X=MsPortalFx.Errors,Y=J.Constants.BladeParameterNames,Z=J.Diagnostics,ee=Z.Telemetry,te=J.Images,ie=MsPortalFx.Extension.SetRequirement,ne=ee.ActionModifier;const se=window.fx.getTimestamp,oe=Z.createLog(e),ae=n.Asset,re=n.Blade,le=n.Shell.Reader,de="__{0}_StatusBarCommandDefinitionName__",ce=!!MsPortalFx.trace.bladerebind,he=Math.random()<.5,ue=MsPortalFx.isNullOrUndefined,pe="fxs-menublade",me="fxs-blade-shows-pending",ge=Array.isArray,fe=1e3,be=ko.toJSON,_e=ko.utils,xe=_e.peekObservable,Ce=MsPortalFx.disposeDisposable,ye=JSON.stringify,{cancelOnDispose:Ie}=MsPortalFx.Base.Promises;function we(e){return e.getExtensionLocator()}function ve(e){const t=e&&we(e);return t&&t.name}function Me(e){return e&&e.toFriendlyString()}function Pe(e){const t=e.openedByInfo,i=t&&t.openedByContext;return i&&i.openedAsHome}function Be(e){const t=e.masterContainer,i=t&&t.bladeDefinition;return!(!i||!i.menuBlade)}function Se(e){const t=e.headerContainer,i=t&&t.bladeDefinition;return!(!i||!i.tabMenuBlade)}function De(e){return!(e.menuBlade||e.tabMenuBlade||12===e.style)}function Te(e,t,i){e.options.showTranslucentSpinner(!1),i.menuBlade&&(e.clearDetailContent(),t.bladeWidth(2)),i.tabMenuBlade&&e.clearHeaderContent();const n=t.contextMenu,s=n&&n.menuItems;s&&s.splice(0,s().length)}var ke;function Ee(e){const t=e.effectiveInputs;return t&&t.length&&e.assetIdInputProperty&&e.assetType}function Fe(e){const t=e&&e.options,i=t&&t.noticeTmplVm;return!(!i||!i.value)}function Re(e,t,i){let n,s={exists:!1,value:void 0};if(Ee(e)){n=MsPortalFx.find(e.effectiveInputs,(t=>t.property===e.assetIdInputProperty));const o=n&&n.valuesFrom,a=o&&o[0]&&o[0].property;a&&1===o[0].referenceType&&(s=(0,j.getModelValue)(t,a),s.exists?s.value=ko.unwrap(s.value):oe.error(`Asset id property '${a}' does not exist in model for composition '${i}'. Model='${be(t)}'`))}return s}t.create=function(e,t,i){const n=e.createChildContainer("composition");n.set(S.BladeDescriptor,t);const s=e.get(u.ViewModelManager).getBladeSequenceNumber(t.locator.getExtensionName(),t.locator.name,t.model),o=new Ae(n,t.locator,s);o.registerForDispose((()=>n.disposeAsync()));const a={};if(!i)throw new Error("masterContainer is required when creating a blade.");i.bladeDefinition?.tabMenuBlade&&(o.headerContainer=i,i.masterContainer.bladeDefinition?.menuBlade&&(i=i.masterContainer)),o.masterContainer=i,o.masterCommandId=t.masterCommandId,o.masterCommandName=t.masterCommandName,o.masterCommandExtension=t.masterCommandExtension,o.masterPartId=t.masterPartId,o.masterInvocationProperty=t.masterInvocationProperty,o.masterInputKeys=t.masterInputKeys,o.masterDetailsDefinition=t.masterDetailsDefinition,o.flags=t.flags,o.telemetryName=t.telemetryName,o.openInitiatedTimestamp=t.timestamp;const r=t.masterPartId?t.masterPartId.split("-"):[],l=t.openedByContext,d=o.openedByInfo;if(o.defaultMenuItemId=t.defaultMenuItemId,o.contentBladeReference=t.contentBladeReference,i.getCompositionType()===F.CompositionType.Startboard){if(r.length)d.openedBy=1;else if(l)switch(l.openedBy){case 1:d.openedBy=2;break;case 2:d.openedBy=5;break;case 3:d.openedBy=6;break;case 4:d.openedBy=3;break;case 5:d.openedBy=7;break;case 6:d.openedBy=8;break;case 7:d.openedBy=9;break;case 8:d.openedBy=10;break;case 9:d.openedBy=11;break;case 10:d.openedBy=12;break;case 11:d.openedBy=13;break;case 12:d.openedBy=14;break;default:d.openedBy=4}d.openedByContext=t.openedByContext,d.openedByPartName=t.masterPartId}const h=e.get(c.DefinitionFinder);return h.tryLocate(t.locator,a)&&(o.bladeDefinition=a.value,o.extension=h.locate(we(t.locator))),t.locator?.name.toLowerCase().endsWith("_dx")&&t.model&&(t.model.dxParameters=MsPortalFx.clone(t.model,!0),t.masterInputKeys.push("dxParameters")),o.setInputsViewModel(W.CompositionBinder.createObservableModel(t.model)),o.bindings=t.bindings||[],o.restorationState=void 0===t.flags||4&t.flags?0:1,e.get(A.BladeHistory).recordBladeOpened(o),o},function(e){e[e.ErrorUnrecoverable=1]="ErrorUnrecoverable",e[e.ErrorInitializing=2]="ErrorInitializing",e[e.ErrorLoadingExtension=3]="ErrorLoadingExtension",e[e.ErrorLoadingDefinition=4]="ErrorLoadingDefinition",e[e.ErrorLoadingExtensionAndDefinition=5]="ErrorLoadingExtensionAndDefinition",e[e.ErrorLoadingFramePart=6]="ErrorLoadingFramePart",e[e.FullReadyTimeout=7]="FullReadyTimeout"}(ke||(ke={}));class Ae extends R.Instance{constructor(e,t,n,o={}){super("Blade",e,t,o.children,null,o.id,n),this._diContainer=e,this._disposablesEvents=[],this._partAwaiter=new U.CompositionAwaiter(!0),this._containerAwaiter=new U.CompositionAwaiter,this._bindingResult=ko.observable(),this._disabled=!1,this._rebinding=!1,this._composing=!1,this._initialized=!1,this._callbacks=[$.Callbacks(),$.Callbacks(),$.Callbacks()],this._initialOnInputsSetDeferred=Promise.withResolvers(),this._announce=new m.PortalReader(this,{idPrefix:"bladecompo"}),this._bladeViewModelDeferred=Promise.withResolvers(),this._compositionDeferred=Promise.withResolvers(),this._commandsDeferred=Promise.withResolvers(),this._lastInputsSetDeferred=Promise.withResolvers(),this._lastInputsSetProperties={},this._perfData={},this._bladeSummaryCollapsed=!1,this._isOpenedByReferrer=ko.observable(!1),this._bladeDefinitionDeferred=Promise.withResolvers(),this._shareItExp=ko.observable(!1),this.bladeDefinitionPromise=this._bladeDefinitionDeferred.promise,this.masterContainer=null,this.headerContainer=null,this.containerType=1,this.masterInputKeys=[],this.masterDetailsDefinition=null,this.bindings=[],this.editScopeId=ko.observable(),this.title=ko.observable(""),this.subtitle=ko.observable(""),this.titleSuffix=ko.observable(),this.subtitleSuffix=ko.observable(),this.description=ko.observable(""),this.helpUri=ko.observable(),this.shieldType=ko.observable(),this.uiBlockers=ko.observableArray([]),this.icon=ko.observable(te.Polychromatic.DefaultBlade()),this.titleImageUri=ko.observable(),this.rebindThrottler=function(){let e,t,i=0;function n(){e&&(e.reject(new X.CanceledError("Throttler cancel pending promise")),clearTimeout(t),e=null)}return{rejectPendingPromise:n,throttle:()=>{const s=Date.now(),o=s-i<fe;if(i=s,n(),o){const i=e=Promise.withResolvers();return t=setTimeout((()=>{i===e&&(e.resolve(void 0),e=null)}),fe),i.promise}return Promise.resolve()}}}(),this.assetId=ko.observable(),this.restorationState=0,this.openedByInfo={},this.menuDeepLink=ko.observable(),this.fullReadyTime=ko.observable(),this._beforePageUnload=e=>{const t=this.editScopeId(),i=t&&this.diContainer.get(f.EditScopeManager).getStateObservable(t);(this.shouldAlertOnClose()||i&&0!==i())&&(e.preventDefault(),e.returnValue="")},this.eligibleForBinding=!0,this._childrenCreated=!1,this._viewModelManager=e.get(u.ViewModelManager),this._finder=e.get(c.DefinitionFinder),this._telemetry=new L.BladeTelemetry(e),e.set(L.BladeTelemetry,this._telemetry);const a=this._sequenceNumber=n||(0,u.getNextSequenceNumber)();let r=0;(this._updateRebindSequenceNumber=()=>{this.instanceId=`Blade_${MsPortalFx.sessionId}_${a}_${r++}`})(),e.set(s.CompositionProvenance,new s.CompositionProvenance(t,this.instanceId)),this._shellViewModel={},this.title((0,C.getDefaultTitle)(t&&t.name)),window.addEventListener("beforeunload",this._beforePageUnload),e.get(d.Experimentation).shellAssignments.whenAvailable().then((t=>{(0,i.isFeatureEnabled)("ci")||!t.getBooleanValue("FavoritesInMenu")&&!MsPortalFx.isFeatureEnabled("FavoritesInMenu")||this._injectCollapsibleMenuTour(),t.getBooleanValue("showTourGuide")&&e.get(b.TourGuideManager),t.getBooleanValue("shareItExp")&&this._shareItExp(!0)})),this._compositionDeferred.promise.then((()=>{const e=this.bladeDefinition;if(e&&e.locked){const t=this.getParts();ko.reactor(this,(()=>{const i=t.some((e=>e.triggeringLockedBladeSpinner()));this.containerWidget.options.showTranslucentSpinner(i),this._composing||e.menuBlade||e.tabMenuBlade||(i?this._announce.read(le.bladeBusy):this._announce.read(le.bladeReady))}))}}))}_injectCollapsibleMenuTour(){window.addEventListener("fxmenubladerendered",(async()=>{const e=this.widget?.element[0];if(e?.classList.contains("fxs-bladesize-menu")){const e=this._diContainer.get(b.TourGuideManager),t="12/31/2024";if(await e.checkTourSettings("HubsExtension","UpdatedCollapsibleMenuSettings",t)){const i=(0,T.getCollapsibleMenuTourOptions)(t);e.displayTour(i)}}}),{once:!0})}shouldAlertOnClose(e){return this.children.some((t=>t.children.some((t=>t.shouldAlertOnClose(e)))))}getAlertOnCloseMessages(){const e=[];return this.children.forEach((t=>{t.children.forEach((t=>{const i=t.getAlertMessage();i&&e.push(i)}))})),e}isRestorable(){return 0===this.restorationState&&!$e(this).some((e=>1===e.restorationState))}getViewModel(e,t){let i;const n=this.locator;switch(e=ue(e)?1:e){case 1:i=this._shellViewModel;break;case 3:if(!this.isComposed)throw new Error(`Blade '${this}' needs to be composed before retrieving its extension view model.`);this.bladeDefinition.viewModelName||oe.error(`Blade '${n}' does not define an extension view model.`),i=(0,E.isPromise)(this._extensionViewModel)?void 0:this._extensionViewModel;break;case 2:if(!this.isComposed)throw new Error(`Blade '${this}' needs to be composed before retrieving its action bar's view model.`);this.actionBar?i=this.actionBar.getViewModel():(oe.error(`Blade '${n}' does not have an action bar.`),i={});break;case 4:{const e=this._getCommands(),n=(0,F.findCommand)(e,t,this+"");i=n&&n.getViewModel();break}case 999:i={parameters:this._shellViewModel};break;default:oe.error(`Invalid model type '${e}' for blade '${n}'.`)}return i||{}}selectedMenuItemId(){const e=this.menu,t=e&&e.getSelectedItem();return t&&t.id}setDeepLinkContext(t,i,n,o){if(this._perfData.deepLinkContext={deepLinkable:i,length:t.length,reason:n,details:o},!i){let i="Could not create a deep link for the content.";switch(n){case"BladeHasOutputs":return;case"InputsExceedURILength":i+=` The deep link was too long with ${t.length} characters in it.`;break;case"BladeNotPinnableCannotUpgrade_UnsupportedDate":case"UnableToSerializeInputTypeDate":i+=" Input contains a Date type. Date type cannot be roundtripped from JSON without special processing. Either process the Date entry as a string in your inputs, or remove from the inputs.";break;case"UnableToSerializeInputTypeOther":i+=" Input contains a type that cannot be serialized to JSON."}i+=` REASON: ${n} DETAILS: ${o}`,(0,s.logToExtension)(e,ve(this.locator),2,i,{contextData:{blade:this.locator?.name||"Unknown_Locator"},diContainer:this.diContainer})}}getDeepLinkContext(){return this._perfData.deepLinkContext}async getDeepLink(e){let t;await this.await(7),this.bladeDefinition.viewModelInputs&&await this.await(4);const i=this.useDetailContent||Be(this),n=(this.useHeaderContent||Se(this))&&!i;if((!this.useDetailContent&&!this.useHeaderContent||n)&&!(1&this.flags)){const e=this.getInputPropertyBindings();t=(0,_.getDeepLink)(this.diContainer,this.extension.name,this.bladeDefinition,e&&e.targetModel,{assetType:this.assetType,assetId:ko.unwrap(this.assetId),selectedMenuItemId:this.selectedMenuItemId(),setDeepLinkContext:(e,t,i,n)=>this.setDeepLinkContext(e,t,i,n)})}return ue(t)&&(this.useDetailContent||!e)&&this.masterContainer?this.masterContainer.getDeepLink():t}async getViewModelAsync(e,t){if(1===(e=ue(e)?1:e)||999===e)return this.getViewModel(e);if(await this._compositionDeferred.promise,this.isDisposed())throw new MsPortalFx.Errors.DisposedCanceledError;if(4===e)return this._commandsDeferred.promise.then((()=>{const e=this._getCommands(),i=(0,F.findCommand)(e,t,this+"");return i&&i.getViewModelAsync()}));if(3===e){if(!this._extensionViewModel)throw new MsPortalFx.Errors.Error("No extension view model loaded");return this._extensionViewModel}return this.getViewModel(e)}setInputsViewModel(e){this._shellViewModel=e;const t=this.bladeDefinition;t&&ge(t.optionalInputs)&&t.optionalInputs.forEach((t=>{e[t]||(e[t]=ko.observable())}))}get isInitialized(){return this._initialized}get journeyPath(){return this._journeyPath||(this._journeyPath=this._buildJourneyPath())}get dirtyAndNotSaving(){return 1===this.diContainer.get(f.EditScopeManager).getStateObservable(this.editScopeId())()}getCompositionType(){return F.CompositionType.Blade}isDefaultTitle(){return(0,C.getDefaultTitle)(this.locator.name)===this.title()}getPermissionPromise(){return this._hasPermissionsDeferred.promise}getInputsOnlyViewModel(){let e=this._shellViewModel;const t=this.bladeDefinition,i=t&&t.outputs;return i&&i.length>0&&(e=MsPortalFx.clone(this._shellViewModel),i.forEach((t=>{delete e[t]}))),e}async onAddingContent(e,t){this.compose(e.getWidget(),t?{index:e.childElementCount.value}:null)}onRemovingContent(e){e.getWidget().clear()}canRemoveContent(){return He(this.diContainer).tryCloseBlade(this)}get isDisabled(){return this._disabled}isPinnable(){const e=this.bladeDefinition;return!(!e||!e.pinnable)}isEditable(){const e=this.bladeDefinition;return!(!e||!e.dxSourcePath)}async getPinOptions(){let e,t,i,n;const s=$e(this),o=s[0],a=!!(1&this.flags);1===s.length&&o.useDetailContent&&o.isPinnable()?(e=a?Promise.resolve(void 0):this.getDeepLink(),t=o.locator,i=o.getViewModel(),n=o.getOnPinFunction()):(t=this.locator,i=this.getViewModel(),e=Promise.resolve(void 0),n=this.getOnPinFunction());const[r,l]=await Promise.all([n,e]),d={deepLink:l,bladeTitle:this.containerWidget.options.title.value,defaultMenuItemId:this.selectedMenuItemId()};return r?MsPortalFx.extend(d,{locator:t,onPin:r}):MsPortalFx.extend(d,{locator:t,model:i})}async getOnPinFunction(){await this.await(3);const e=(await this.getViewModelAsync(3)).content();return e&&e._msPortalFxV2ShellApi&&e._msPortalFxV2ShellApi().onPin}static async getSourceModified(e){await e.await(3);return(await e.getViewModelAsync(3)).container.onSourceModified}async getAssetInstanceMetadataAsync(){await this.await(7);const e=this.bladeDefinition;if(Ee(e)&&!this.isDisabled&&!this.isDisposed()){const t=Re(e,this._shellViewModel,this.locator.toString());if(t.exists)return{id:t.value,type:this.assetType}}}get assetType(){const e=this.bladeDefinition;return e&&e.assetType}offRebind(e,t,i){[e,t,i].forEach(((e,t)=>{e&&this._callbacks[t].remove(e)}))}onRebind(e,t,i){[e,t,i].forEach(((e,t)=>{e&&this._callbacks[t].add(e)}))}save(e){this._composing||this._rebinding||Fe(this.widget)||!this.masterContainer||super.save(e)}rebindAsync(e){this._updateRebindSequenceNumber(),G.provideContext((()=>{this._creationState=G.getState()}),K.Blade,Ve(this));const t=this.widget;p.FocusHandler.Instance.registerContainerForFocus(t,this.containerWidget),this.containerWidget.resetInternalState();const i=(0,q.getPortalViewModel)(this.diContainer);let n;const s=(0,F.deepSubset)(this._shellViewModel,e),o=e=>{We(this,"Rebind COMPLETED."),this._rebinding=!1,this.save(),i.customEvents.trigger("fxbladerebound",{id:this.id}),this.widget.options.loaded(!0),this.diContainer.get(M.CommandState).commandsEnabled(!0),p.FocusHandler.Instance.notifyContainerReadyForFocus(t)};return We(this,"Rebind STARTED.",e),this._rebindValidationPromise=null,this._waitToRebindPromise=null,this._directoryInfoPromise=null,s?(We(this,"Updated properties are empty or are equal to the current blade properties. Aborting rebind.",e),this.rebindThrottler.rejectPendingPromise(),o(ne.Cancel),n=Promise.resolve({})):(this._rebinding=!0,this._hasPermissionsDeferred=Promise.withResolvers(),this.bladeDefinition&&!this.bladeDefinition.locked&&this.widget.options.loaded(!1),this.diContainer.get(M.CommandState).commandsEnabled(!1),n=this._waitToRebindPromise=this.rebindThrottler.throttle().then((()=>this.isDisposed()?Promise.reject(new X.CanceledError("Rebind Canceled. Blade is already disposed."+this)):n===this._waitToRebindPromise?(We(this,"Rebind after throttle.",e),this._rebindAsync(e).finally((()=>{n===this._waitToRebindPromise&&o(ne.Complete)}))):Promise.reject(new X.CanceledError("Another rebind already started"))))),n}getTelemetryContextState(){return this._creationState}_rebindAsync(e){const t=this._rebindValidationPromise=this.await(7).then((()=>{if(!this._validateRebindProperties(e))return Promise.reject(new MsPortalFx.Errors.CanceledError)})),n=t=>{(0,i.forEachKey)(e,(e=>{(0,j.setModelValue)(this._shellViewModel,e,t?t[e]:void 0)})),t&&(this._journeyPath=this._buildJourneyPath())};return this.useDetailContent||this.containerWidget.clearDetailContent({callback:()=>{const e=this.menu;e&&e.setDefaultId({rebinding:!0})},setPlaceholderDetailContent:!(!this.bladeDefinition.menuBlade&&!this.bladeDefinition.tabMenuBlade||$e(this).length)}),this.useHeaderContent||this.containerWidget.clearHeaderContent(),t.then((()=>{const i=this._bindingsToExtensionViewModel&&this._bindingsToExtensionViewModel.properties.map((e=>e.compositionBindingDefinition)).filter((e=>!!e));this._lastInputsSetDeferred.reject(new MsPortalFx.Errors.CanceledError("New rebind started")),this._lastInputsSetDeferred=Promise.withResolvers();const s=(i||[]).filter((e=>!e.optional));if(this._lastInputsSetProperties=(0,j.mapSourceModelToTargetModel)(e,s,1,this+""),function(e,t,i){if(!e)return!1;const n=e.properties.filter((e=>{const t=e.compositionBindingDefinition;return t&&t.source&&1===t.source.modelType}));if(0===n.length)return!1;return n.some((e=>{const n=ko.unwrap(t[e.sourceProperty]),s=ko.unwrap(i[e.sourceProperty]);return!MsPortalFx.deepEquals(n,s)}))}(this._bindingsToExtensionViewModel,this._shellViewModel,e)||this._lastInputsSetDeferred.resolve(void 0),this.isDisposed())return Promise.reject(new MsPortalFx.Errors.DisposedCanceledError);if(t&&t!==this._rebindValidationPromise)return Promise.reject(new MsPortalFx.Errors.CanceledError("Another rebind has started"));{We(this,"Updating blade properties.",e);const t=this._callbacks;t[0].fire(e);const i=this._bindingResult()&&this._bindingResult().inputsWatcherConfig;return i&&W.CompositionBinder.turnOnInputsSetSuppressionOn(i),n(void 0),this._clearEditScopeId(),this.setInputsViewModel(this._shellViewModel),(this.bladeDefinition.optionalInputs||[]).forEach((e=>{this._shellViewModel[e](void 0)})),n(e),this._setEditScope(),i&&W.CompositionBinder.turnOnInputsSetSuppressionOff(i),t[2].fire(e),this.bladeDefinition.viewModelInputs||this._hasPermissionsDeferred.resolve(void 0),this._lastInputsSetDeferred.promise.catch((()=>{})).finally((()=>{We(this,"Inputs set promise completed.",e),this.save(),t[1].fire(e)}))}}))}onDetailContainersChanged(){this._finder.locateAsync(this.locator).then((e=>{this._widgetsCreated&&this._initWidgetFromDefinition(e)}))}_compose(e,t,i){if(this.isComposed||this._composing)return;if(this._composing=!0,this._perfData=this._telemetry.initializeBladeTelemetry(i&&i.assetType,this,he),this._compositionDeferred.promise.then((()=>{if(t.resolve(),this._perfData.bladeLoadedTime=this.compositionTime=se()-this._telemetry.readyStartTime,!Fe(this.widget))return this._setupCommandBarAndContextMenu()}),(()=>{t.reject()})).then((()=>{this._commandsDeferred.resolve()})),this.unrecoverableErrorMessage)return void this._composeErrorBlade(e,i,ke.ErrorUnrecoverable,this.unrecoverableErrorMessage);const n=this.locator,s=this._finder,o=this._viewModelManager.tryEarlyGetViewModel(we(n).name,n.name,FxImpl.mapValues(this._shellViewModel,ko.unwrap),{menuId:this.defaultMenuItemId,inContextPane:!!(1&this.flags),inSideBar:!!(256&this.flags),inDockedContextPane:!!(512&this.flags),isMenuBladeContent:!!this.diContainer.get(O.Finder).findParentMenuBlade(this),fetchDefinition:!this.bladeDefinition,sequenceNumber:this._sequenceNumber});o.then((e=>{e.viewModel&&(this._perfData.rpcDurationMs=e.rpcDurationMs,this._perfData.viewModelLoadIndex=e.viewModelLoadIndex)})),this.tryGetVirtualPartViewModel=()=>MsPortalFx.tryImmediateResolve(o,(e=>{const t=e.viewModel;return t&&(this.tryGetVirtualPartViewModel=()=>Promise.resolve(null)),t}));const a=this.bladeDefinition?Q(this.bladeDefinition):Q(o).then((()=>s.locateAsync(n)));a.then(this._bladeDefinitionDeferred.resolve),this._getExtensionPerfData();const r=this.extension?Promise.resolve(this.extension):s.locateAsync(we(n));if(this._shouldShowPendingBlade()){(()=>{const t=this._createNewBladeWidget(e,i);t.element.addClass(me),t.options.close=()=>He(this.diContainer).tryCloseBlade(this,1),this._widgetsCreated=!0,this.containerWidget=t,this.widget=t.getContentWidget(),"ResourceMenuBlade"===n.name&&this.containerWidget.setupAsKnownMenuBlade()})()}else{const t=this.masterContainer;t&&t.bladeDefinition&&t.bladeDefinition.menuBlade&&t.bladeDefinition.tabMenuBlade&&(!t.containerWidget.isMenuBladeLoadingDetailBlade()||t.containerWidget.element.hasClass(me))||this._loadingSignalToTopBar(e.element)}a.then((t=>{if(this.bladeDefinition=t,t.menuBlade||t.tabMenuBlade||this._announce.read(le.bladeLoading),3===this.openedByInfo.openedBy&&!this.isPinnable()&&this.masterInputKeys&&this.masterInputKeys.length){const e=this.openedByInfo.openedByContext.deepLink;e&&/^#(?:[^/]+\/)?blade\//.test(e)&&this._trace({extension:this.extension&&this.extension.name||ve(n),action:"BladeDeepLinkedNotPinnable",source:"Shell",data:{resource:e}})}this.isDisposed()||(this._initWidgets(t,e,i),this._showLoadingIndicator());let s=ke.ErrorLoadingExtensionAndDefinition;return r.then((n=>{s=ke.ErrorLoadingDefinition,this.extension=n,!this.isDisposed()&&(4&t.attributes||this._validateParameters(e,t,i))&&this._validateDefinition(e,t,i)&&(this.bindings=this.bindings.concat(W.CompositionBinder.mapInputBindingDefinitions(t.bindings,this,(e=>{e.source.scope===j.ReferenceScope.CurrentContainer&&(e.autoRebindWhenSourceDisposes=!0)}))),this._createChildrenFromDefinition(t),this.save(),this._initialized=!0,this._composeBlade(n,t))})).catch((t=>{this._composeErrorBlade(e,i,s,t)}))})).catch((t=>{let n=ke.ErrorLoadingExtensionAndDefinition;a.isRejected()||(n=ke.ErrorLoadingExtension),this._composeErrorBlade(e,i,n,t)})).finally((()=>{this._loadedSignalToTopBar()}))}_selectedMenuItemIcon(){let e=null;Be(this)?e=this.masterContainer.menu:Se(this)&&(e=this.headerContainer.menu);const t=e&&e.getSelectedItem();return t&&ko.unwrap(t.icon)}_shouldShowPendingBlade(){const e=0!=(16&this.flags),t=0!=(1&this.flags);return!Be(this)&&!Se(this)&&(!e||t)&&!function(e){for(;e;){if(Ne(e))return!0;const t=e.masterContainer;e=t instanceof Ae?t:null}return!1}(this)}_loadedSignalToTopBar(){this._loadingHintDisposer&&(this._loadingHintDisposer(),this._loadingHintDisposer=null)}_loadingSignalToTopBar(e){this._loadedSignalToTopBar(),this._loadingHintDisposer=()=>{e.trigger("fxloadingontopbar",{id:this.id,cancel:!0})},e.trigger("fxloadingontopbar",{id:this.id,cancel:!1})}_showLoadingIndicator(){this.widget.options.loaded(!1),this._hasPermissionsDeferred=Promise.withResolvers(),Promise.allSettled([this._hasPermissionsDeferred.promise,this._compositionDeferred.promise]).finally((()=>{this.widget.options.loaded(!0)}))}_rejectPermissionsPromise(){this._hasPermissionsDeferred?this._hasPermissionsDeferred.reject():this.widget&&this.widget.options.loaded(!0)}_validateRebindProperties(e){let t="";const i=this.bladeDefinition.templateKeyInputs||[];return i.some((t=>!e.hasOwnProperty(t)))?t="Properties to rebind must include all blade inputs marked as keys.":i.some((t=>ge(e[t])))&&(t="Properties to rebind cannot be of Array type."),t&&oe.error(`[Blade Rebind] ${t} Rebind properties:'${ye(e)}', Blade keys:'${ye(i)}'.`),!t}_summaryCollapsed(){let e,t,i=!1;return(this.bladeDefinition.lenses||[]).some((n=>{const s=this.locator.withLens(n.name),o=this._finder.locate(s);return o&&o.isSummary&&o.partInstances&&(i=!0,e=o.partInstances[0],t=s.withPartInstance(e.name)),i})),i?this._sharedSettings.querySetting(2,"[PartIdentityState]-"+t.toString()).then((e=>e?FxImpl.fromSerializableObject(e):null),(()=>null)).then((t=>t&&t.content&&void 0!==t.content.collapsed?!!t.content.collapsed:e.inline&&e.inline.options?!!e.inline.options.collapsed:null)):Promise.resolve(!0)}_checkIfOpenedByReferrer(e,t){const i=Y.ReferrerInfo,n=e.includes(i),s=void 0!==ko.unwrap(t[i]);return n&&s}_composeBlade(e,t){he&&this._summaryCollapsed(),t.assetType&&this.containerWidget.options.associatedWithAsset(!0);const i=this._journey=He(this.diContainer).activeJourney();this.journeyId=i&&i.id||"N/A",this._setupViewModel(),t.editScopeType&&i&&i.observeEditScopeChanges(this,{editScopeId:this.editScopeId,ownerType:this.locator.type,ownerLocatable:this,disposeOnSelectionChange:!1}),this._isOpenedByReferrer(this._checkIfOpenedByReferrer(t.optionalInputs||[],this._shellViewModel)),this._setupInputBindings(),this._setupExtensionViewModel(),this._setupPreviewListener(e,t),this._trackAssetIdChange(),this._waitForNoticeIfAny(t.waitForInputsSet).then((e=>{e&&this._composeAndRestoreLayout().then((()=>{$e(this).forEach((e=>{e.notifyContainer(this)})),this.masterContainer&&this.masterContainer.notifyContainer(this),function(e,t,i){const n=t?t.name:null,s=i?i.assetType:null;let o=1;e.children.forEach((t=>{t.children.forEach((t=>{ee.trace({extension:n,source:Me(e.locator),action:"PartPosition",assetType:s,name:Me(t.locator),data:o}),o++}))}))}(this,this.extension,t),this.save(),this.actionBar?this.actionBar.await(7).then((()=>{this._compositionDeferred.resolve()})):this._compositionDeferred.resolve()}),(()=>{this._compositionDeferred.reject()}))})),this.onRebind(),this.containerWidget.bladeDefinitionLoaded=!0,this.containerWidget.trigger("fxbladerepos")}async _waitForNoticeIfAny(e){if(e){if(await this.await(3),this.isDisposed())return!0;const e=await this._extensionViewModel,t=xe(e.container._msPortalFxNotice),i=ue(t);return i||this._renderNotice(t),i}return!0}_buildJourneyPath(){const e=this.masterContainer,t=e&&e.journeyPath||[],i={model:{}};return(this.masterInputKeys||[]).forEach((e=>{i.model[e]=ko.unwrap(this._shellViewModel[e])})),t.concat([V.getBladeOpenerJourneyPathSegment(this),MsPortalFx.toSortedString(i),this.locator.toString()])}_createNewBladeWidget(e,t){t=t||{};const s=new C.ViewModel(this.id,this._diContainer,this.widgetState(),{name:this.locator.name,extensionName:ve(this.locator)});s.asSubJourney=0!=(8&this.flags),s.customHome=Pe(this),s.showMinimize=!!(128&this.flags),s.showMaximize=!!(512&this.flags),(0,i.isFeatureEnabled)("mspinfo")&&this.assetId.subscribeAndRun(this,(e=>{s.directoryInfo(null),e&&(this._directoryInfoPromise=MsPortalFx.require("MsPortalImpl/Services/Services.ProjectedDirectories").then((e=>this._diContainer.getAsync(e.ServicesProjectedDirectories))).then((t=>t.hasProjectedDirectories().then((i=>{if(i)return t.getDirectoryByResourceId(e).then((e=>{const t=te.StatusBadge;let i=e&&(e.displayName||e.id),o=t.Info();i||(i=n.ResourceFilter.Directory.unknownText,o=t.Unknown()),s.directoryInfo({directoryName:n.Directory.label.format(i),directoryIcon:o})}))})))))}));const o=(0,C.createBladeWidget)($(FxImpl.createElement("section")),s);return 256&this.flags||(t.index>=0?e.insertChild(o,t.index):e.addChild(o)),o}_initWidgets(e,t,i){let n,s;i=i||{};let o=null,r=null;const l=this.masterContainer,d=l&&l.containerWidget,c=this.useDetailContent||Be(this),h=this.useHeaderContent||Se(this),u=12===e.style,m=!!e.menuBlade,g=!!e.tabMenuBlade,f=0!=(1&this.flags),b=0!=(16&this.flags)&&!f,_=this.useHeaderContent=function(e){return!!e.tabMenuBlade}(e),x=this.useDetailContent=!_&&(c||h)&&De(e)||b,C=c&&!x,I=Pe(this);if(b||x){n=d,r=new y.ViewModel(this.id,{displayState:n.options.displayState,diContainer:this.diContainer},{name:this.locator.name,extensionName:ve(this.locator)}),r.applyViewSettings(this.widgetState()),n.options.isMenuBlade(m),n.options.isTabMenuBlade(g);const e=l.selectedMenuItemId&&l.selectedMenuItemId(),t=c&&this.masterContainer.menu||h&&this.headerContainer.menu,i=t&&t.getDefaultItem()?.id||"overview";if(n.options.isDefaultItemSelected(e===i),n.options.pinEnabled(!1),n.options.pinVisible(!1),this._shareItExp()){const e=this.bladeDefinition.name.startsWith("ResourceGroupOverview");n.options.shareItVisible(e),n.options.shareItEnabled(e)}else n.options.shareItEnabled(!1),n.options.shareItVisible(!1);n.options.editEnabled(!1),n.options.editVisible(!1),n.options.showFavoriteResourceButton(!1),n.options.showEditAssetButton(!1),this.getDeepLink().then((e=>{l.menuDeepLink(e),n.options.deepLink((0,a.getMenuIdFromDeepLink)(e)!==i?(0,a.replaceMenuIdFromDeepLink)(e,i):e)}))}else _?(n=c?d:this.containerWidget,r=new y.ViewModel(this.id,{displayState:n.options.displayState,diContainer:this.diContainer},{name:this.locator.name,extensionName:ve(this.locator)})):m||g||this.getDeepLink().then((e=>{n.options.deepLink(e)}));b?s=n.openBladeInPlace(this,r):_?s=n.setHeaderContent(r,!c):x?s=n.setDetailContent(r):this._widgetsCreated?(n=this.containerWidget,o=n.options,s=this.widget):(n=this._createNewBladeWidget(t,i),o=n.options,s=n.getContentWidget()),this._widgetsCreated=!0,this.containerWidget=n,this.widget=s,c||(n.options.customHome=I);const w=He(this.diContainer).activeJourney();if(w){const e=w.children,t=e[e.length-2],i=t&&t.masterContainer,n=i&&i.containerWidget,s=n&&n.options,a=i&&i.bladeDefinition,r=a&&a.menuBlade&&De(a)&&!s.useActivationStyle;(C||r)&&o&&(o.asSubJourney=!0)}s.options.isV2Blade(Oe(e)),!x&&!_||_&&!c?n.element.data(F.CompositionInstanceDataName,this):s.element.data(F.CompositionInstanceDataName,this),this._attachEventHandlers(n,s,x,_,C,b,c,h,d),this.widgetState(s.saveViewSettings()),u&&s.options.bladeStyle(12);let v=u||x||m||g||I||3===e.width||e.reflowReady;1&this.flags||v||2===e.initialDisplayState||(v=!0,s.options.forcedMaximize(!0));const M=this._perfData.initialDisplayState=v?2:e.initialDisplayState||1;n.options.displayState(M),this._initContainerWidgetFromDefinition(e,n.options),this._initWidgetFromDefinition(e),c?n.options.showBladeIcon(!!n.options.associatedWithAsset()):n.options.showBladeIcon(!!e.assetType),s.initializeLayout(),n.initializeLayout({setPlaceholderDetailContent:(m||g&&!c)&&!$e(this).length,hideDefaultContent:g&&!c,callback:e=>{m&&e.addClass(pe),g&&e.addClass("fxs-tabmenublade")}}),p.FocusHandler.Instance.registerContainerForFocus(s,n),s.options.locked(e.locked||!1)}_initContainerWidgetFromDefinition(e,t){const i=this.useDetailContent,n=this.useHeaderContent,s=this.masterContainer,o=s&&s.bladeDefinition;o&&o.menuBlade&&!i&&!n&&s.containerWidget.options.displayState(1)}_initWidgetFromDefinition(e){const t=ue(e.width)?1:e.width,i=!ue(e.reflowReady)&&e.reflowReady;this.containerWidget.options.useActivationStyle=!!e.activationStyle;const n=this.widget.options;if(n.bladeWidth(t),n.bladeStyle(e.style),n.reflowReady(i),1&this.flags||512&this.flags){n.displayState(1);const t=e.menuBlade?e.contextPaneWidth||3:e.contextPaneWidth;let i;switch(this.containerWidget.setContextPaneWidth(t),e.style){case 12:i=12;break;case 6:case 8:case 4:case 3:case 9:case 10:i=4;break;default:i=7}n.bladeStyle(i)}}_composeErrorBlade(e,t,i,s){if(this.isDisposed())return;const o=this.locator;this.bladeDefinition=this.bladeDefinition||{name:o&&o.name,lenses:[],locked:!0};const a=s&&s.message||MsPortalFx.getLogFriendlyMessage(s)||"N/A",{data:r,stack:l,status:d}=s,c={details:a,resourceId:this._findResourceId(),status:d,stack:l,...r};this._telemetry.traceBladeLoadErrored(ke[i],c);const h=`Blade '${this}' has been turned to error mode. Details: ${a}`;oe.error(h,void 0,s,c),this._widgetsCreated||this._initWidgets(this.bladeDefinition,e,t);const u=this.containerWidget,p=u.options;p.locked(!0),p.titleImageUri(void 0),this._renderError({message:n.PartError.titleContent,summaryItems:[{label:n.PartError.errorReason,value:ke[i]}],details:s},{bladeTitle:re.error}),this._compositionDeferred.reject(new MsPortalFx.Errors.CanceledError(h)),this._rejectPermissionsPromise(),this._announce.read(le.bladeError),u.bladeDefinitionLoaded=!0,u.trigger("fxbladerepos")}disableForAssetDeleted(e,t){if(this.useDetailContent)return void this.masterContainer.disableForAssetDeleted(e,t);const i=`Blade ${this} ${e?"closed":"disabled"} because asset deleted. Reason: ${t}`;if(e)oe.warning(i),He(this.diContainer).forceCloseBlade(this);else{for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);const e=this.containerWidget,t=e&&e.options;t&&t.titleImageUri(void 0),this._renderError({message:ae.deletedSubTitle,code:410},{bladeTitle:ae.deletedTitle}),this.bindings=[],this._compositionDeferred.reject(),this._rejectPermissionsPromise(),oe.warning(i)}this.save()}resetLayout(e){return this.await(7).then((()=>{const t=$e(this)[0];if(t&&t.useDetailContent)return t.resetLayout(e);const i=this.diContainer;let n;if(e)n=Promise.resolve(6);else{const e=new x.MessageBox(re.resetConfirmationTitle,re.resetConfirmationText,4);n=i.getAsync(x.DialogManager).then((t=>t.showDialog(e,this.widget,this.widget.element[0],{locator:this.locator})))}return n.then((e=>{if(6===e){if(!He(i).discardEditsOfBlade(this,{includeSelf:!0,includeDescendants:!0,force:!0}).successful)return void oe.error(`Unexpectedly failed to discard changes on the blade with id: '${this.id}'`);if(!He(i).closeChildBlades(this).successful)return void oe.error(`Unexpectedly failed to close child blades of the blade with id: '${this.id}'`);this.widget.options.loaded(!1),this.children.forEach((e=>{e.children.forEach((e=>{e.clearIdentitySettings()}))})),this.removeChildren(),this._childrenCreated=!1,this._createChildrenFromDefinition(this.bladeDefinition),this._removeRedirectParts(),this._composeChildren(),this.save(),this.widget.options.loaded(!0)}}))}))}async _setupCommandBarAndContextMenu(){const e=this.widget.options,t=this.bladeDefinition;Ce(this._commandBarLifetime);const i=this._commandBarLifetime=this.createChildLifetime();await(0,v.create)(i,this,this.diContainer,this._shellViewModel),this._composeShellCommands(e.contextMenu.menuItems,t.locked,e.displayState),i.registerForDispose((()=>{e.commandBar.menuItems([]),e.commandBar.items([]),e.contextMenu.menuItems([])}))}_setupInputBindings(){W.CompositionBinder.setupPropertyBindings(this.diContainer,this,this.getInputPropertyBindings(),this.bindings),this.getInputPropertyBindings().addPropertyChangedHandler((()=>{this.save()}))}getMenuWidget(){return this.menu}getComposedParts(){return this._partAwaiter.resolvedCompositions}getParts(){return MsPortalFx.mapMany(this.children,(e=>e.children))}getInputPropertyBindings(){return this._inputPropertyBindings||(this._inputPropertyBindings=new j.PropertyBindings(this+"",this._shellViewModel)),this._inputPropertyBindings}awaitComposedPart(e,t){return this._partAwaiter.await(e,t)}notifyPartComposed(e){this._partAwaiter.resolve(e)}getWaitingCompositions(){return this._partAwaiter.waitingCompositions}await(e){switch(e){case 3:return this._lastInputsSetDeferred.promise;case 4:return this._initialOnInputsSetDeferred.promise}return super.await(e)}resolveInitialOnInputsSet(){this._initialOnInputsSetDeferred.resolve()}dispose(e){window.removeEventListener("beforeunload",this._beforePageUnload),this._telemetry.beginTraceBladeDisposed(),this._releaseResources(e),this.masterContainer&&!this.masterContainer.isDisposed()&&this.masterPartId&&MsPortalFx.tryImmediateResolve(this.masterContainer.awaitComposedPart(null,(0,F.getIdMatchFunc)(this.masterPartId)),(e=>{e.notifyDetailBladeClosed(this)})),super.dispose(e),this._telemetry.endTraceBladeDisposed(),Be(this)||this._announce.read(le.bladeClosed),this._loadedSignalToTopBar()}_releaseResources(e){Ce(this._disposablesEvents),this._disposablesEvents=[],[this._inputPropertyBindings,this._bindingsToBladeWidgetModel,this._bindingsToExtensionViewModel].forEach((e=>{e&&(e.unbind(),e=null)})),e||this._disposeEditScopes(),this._extensionViewModel&&this.extension&&MsPortalFx.tryImmediateResolve(Q(this._extensionViewModel),(e=>{this._viewModelManager.releaseViewModel(e),this._extensionViewModel=Promise.reject(new MsPortalFx.Errors.DisposedCanceledError)})),this._callbacks.forEach((e=>{e.empty()})),this._journey=null}awaitContainer(e,t){return this._containerAwaiter.await(e,t)}onInvocationStarted(){}notifyContainer(e){this._containerAwaiter.resolve(e)}getDiagnosticsData(){return $.extend(super.getDiagnosticsData(),{title:be(this.title),detailBlades:$e(this).map((e=>e.id)),bindings:W.CompositionBinder.mapBindingsToFriendlyObjects(this.bindings)})}getAssetId(){if(!this.bladeDefinition||!this.bladeDefinition.assetIdInputProperty)return Promise.reject(new X.Error("No asset id found"));let e,t,i=!1;const n=()=>{const i=this._tryGetAssetIdFromBinding();i&&i.exists?e(ko.unwrap(i.value)):t()},s=this._bindingResult,o=()=>{s().allInputsSet()?n():s().allInputsSet.subscribe(this,(e=>{e&&!i&&n()}))},a=new Promise(((n,s)=>{e=e=>{i=!0,n(e)},t=()=>{i=!0,s(new X.Error("No asset id found"))}}));return s()?o():s.subscribe(this,(e=>{e&&!i&&o()})),a}setViewModelForTemplateOrMenuBlade(e){this._bladeViewModelDeferred.resolve(e)}setInputsSetPromise(e){e.finally((()=>{this._initialOnInputsSetDeferred.resolve(),this._lastInputsSetDeferred.resolve(void 0)}))}logFrameBladeLoadError(e){this._trace({action:"IFrameBladeTimeout",data:{details:e}})}_trace(e){const t=this.locator,i=t&&we(t),n=i&&i.name;ee.trace({extension:e.extension||n,source:e.source||"Shell",action:e.action,actionModifier:e.actionModifier,name:e.name||Me(t),data:e.data,journeyId:this.journeyId,duration:e.duration})}_trackAssetIdChange(){if(this.bladeDefinition.menuBlade){const e=MsPortalFx.find(MsPortalFx.mapMany(this.children,(e=>e.children)));ko.reactor(this,(()=>{this.assetId(e.assetId())}))}else(0,F.bladeImplementedWithVirtualPart)(this.bladeDefinition)?ko.reactor(this,(()=>{const e=Re(this.bladeDefinition,this._shellViewModel,this.locator.toString());e.exists&&this.assetId(e.value)})):ko.reactor(this,(()=>{const e=this._bindingResult();if(e&&e.allInputsSet()){const e=this._tryGetAssetIdFromBinding();e&&e.exists&&this.assetId(ko.unwrap(e.value))}}))}_tryGetAssetIdFromBinding(){const e=MsPortalFx.find(this._bindingResult().propertyBindings.properties,(e=>e.targetProperty===this.bladeDefinition.assetIdInputProperty));return e?(0,j.getModelValue)(e.sourceModel,e.sourceProperty):null}_setupViewModel(){(this.bladeDefinition.outputs||[]).forEach((e=>{this._shellViewModel.hasOwnProperty(e)||(this._shellViewModel[e]=ko.observable(void 0))})),this._setEditScope()}_setEditScope(){if(!this.bladeDefinition.editScopeType)return;const e=this._journey&&this._journey.ambientSettings.getItem(this.journeyPath);e&&e.value&&e.value.editScope?this.editScopeId(e.value.editScope.editScopeId):(this.editScopeId((0,i.getUniqueId)()),this.diContainer.get(f.EditScopeManager).onEditScopeCreated(this.editScopeId())),this._shellViewModel[F.EditScopeIdPropertyName]||(this._shellViewModel[F.EditScopeIdPropertyName]=ko.observable()),this._shellViewModel[F.EditScopeIdPropertyName](this.editScopeId())}async _updateForHasPermissions(e){const t=await this.getViewModelAsync(3);if(this.isDisposed())oe.warning(`Blade '${this.locator.toString()}' disposed when checking permissions.`);else{const i=t.container;if(e)!MsPortalFx.isNullOrUndefined(xe(i.unauthorizedMessage))&&i.unauthorizedMessage(null),this._hasPermissionsDeferred.resolve(void 0);else try{await Promise.resolve(i.unauthorized())}finally{this._hasPermissionsDeferred.reject()}}}_setupExtensionViewModel(){const e=this.widget;let t,s;const o=this.bladeDefinition,a=(0,F.bladeImplementedWithVirtualPart)(o),r=e=>(t=this._createBindViewModelConfiguration(e),s=W.CompositionBinder.createBindViewModelResult(this.diContainer,t),s);if(o.viewModelName||o.viewModelLocator||a){const d=`${this}-[${o.viewModelName}]`,c=o.viewModelInputs;let h=Promise.resolve(null);c&&(r(d),s.inputsWatcherConfig&&(h=W.CompositionBinder.loadOnInputsSetParameters(s.inputsWatcherConfig))),this._extensionViewModel=h.then((e=>{c&&(this.earlyOnInputsSet=!!e);const t=G.provideContext((()=>(this._creationState=G.getState(),a?this._bladeViewModelDeferred.promise:this._viewModelManager.getViewModel(this.extension.name,o.viewModelLocator||o.viewModelName,68,{onInputsSetParameters:e}))),K.Blade,Ve(this));return G.provideContext((()=>{this._masterBladeState=G.getState()}),K.Blade,this.masterContainer?Ve(this.masterContainer):null),e?t.then((t=>(W.CompositionBinder.notifyOnInputsSetCalled(s.inputsWatcherConfig,e,t.onInputsSetPromise),t))):t})).then((e=>{const h=this+"-[WidgetModel]",u=e.content();this._extensionViewModel=e;const p=ko.unwrap(e.onInputsSetPromiseState);if(p&&(this._perfData.onInputsSetPromiseState=p.state,this._perfData.onInputsSetPromiseType=H.OnInputsSetPromiseType[p.type]),this.isDisposed())return this._releaseResources(),Promise.reject(new MsPortalFx.Errors.DisposedCanceledError);if(!this.isDisabled){const p=e.container;ko.reactor(this,[p.notFoundMessage,p._msPortalFxHandledError,p.unauthorizedMessage],(()=>{const e=p.notFoundMessage(),t=p._msPortalFxHandledError(),i=p.unauthorizedMessage();if(MsPortalFx.isNullOrWhiteSpace(function(e){if(MsPortalFx.isNullOrUndefined(e)||MsPortalFx.isNullOrUndefined(e.message))return e;{const t=e.message;return"string"==typeof t?t:t.htmlTemplate}}(e)))if(ue(i))ue(t)||this._renderError(t,{});else{const e=this.widget.options,t=ae.unauthorizedMessage,n=e.subtitle(),s=MsPortalFx.isObject(i),o=s?i:{},a=s||i===MsPortalFx.Resources.Strings.ViewModels.Container.unauthorizedText?o.noticeDescription||ae.unauthorizedDescription:i,r={noticeHeader:o.noticeHeader||ae.unauthorizedHeader,noticeTitle:o.noticeTitle||ae.unauthorizedMessage,noticeDescription:a,noticeCallToActionText:o.noticeCallToActionText||"",noticeCallToActionUri:o.noticeCallToActionUri||"",noticeImageType:l.ImageType.Unauthorized,bladeTitle:t,bladeSubtitle:n,shouldDisableBlade:!0},d={bladeTitle:t,bladeSubtitle:n,fallbackErrorCode:403};if("string"==typeof i)this._renderError(i,d);else if(ue(i.message)){const e="<p class='msportalfx-notice-header' data-bind='text: $data.noticeHeader'></p><p class='msportalfx-notice-title' data-bind='text: $data.noticeTitle'></p><p class='msportalfx-notice-description' data-bind='sanitizedHtml: $data.noticeDescription'></p><a class='msportalfx-notice-action' target=\"_blank\" data-bind='attr: { href: $data.noticeCallToActionUri }, visible: $data.noticeCallToActionUri'><span class='msportalfx-notice-secondary-action-text' data-bind='text: $data.noticeCallToActionText'></span></a>";this._renderError({message:{htmlTemplate:e,viewModel:r}},d)}else this._renderError(i,d)}else{const{notFound:t}=n.Container;this._renderError(e,{bladeTitle:t,bladeSubtitle:"",fallbackErrorCode:404})}})),c||a||(this._initialOnInputsSetDeferred.resolve(),this._lastInputsSetDeferred.resolve(void 0)),c?(t||r(d),t.bindableTarget.viewModel=e,s.inputsWatcherConfig&&W.CompositionBinder.setupAllInputsSetWatcherFromExtendedConfig(s.inputsWatcherConfig),this._bindingsToExtensionViewModel=s.propertyBindings,this._bindingResult(s)):this._hasPermissionsDeferred.resolve(void 0);const m=this.containerWidget.options,f=this.widget.options,b=this._bindingsToBladeWidgetModel=new j.PropertyBindings(h,{title:f.title,subtitle:f.subtitle,titleSuffix:f.titleSuffix,subtitleSuffix:f.subtitleSuffix,description:f.description,helpUri:f.helpUri,icon:f.icon,titleImageUri:m.titleImageUri,contentState:f.contentState,contentStateDisplayText:f.contentStateDisplayText});let _,x;ko.reactor(this,(()=>{f.shieldType(this.shieldType())})),ko.reactor(this,(()=>{f.isUiBlocked(this.uiBlockers().some((e=>e())))}));const I=this._selectedMenuItemIcon();Oe(o)?(_=function(e,t,n){const s=ko.observable();function o(e){s(e||null)}const a=e.bladeDefinition;return ko.reactor(e,(async()=>{const s=ko.unwrap(t.icon);if(s)o(s);else if(n)o(n);else if(a.assetType){const t=e.assetId();if(t){const n=e.extension,s={assetId:t,assetType:a.assetType,extensionName:n.name};await(0,i.delay)(1);try{const t=await e.diContainer.get(g.AssetTypeService).mapAssetIdToDynamicSelectionAndIcon(s,"BladeIcon");o(t&&t.icon||y.defaultSvg)}catch{o(y.defaultSvg)}}else o(y.defaultSvg)}else o()})),{icon:s}}(this,u,I),x=null):(_=u,I&&ko.isObservable(_.icon)&&MsPortalFx.deepEquals(_.icon(),y.defaultSvg)&&_.icon(I),x=y.defaultSvg);const w=C.widgetProperties;Ue(b,d,u,w.title,this.title,(0,C.getDefaultTitle)(this.locator.name)),Ue(b,d,u,w.subtitle,this.subtitle,""),Ue(b,d,u,w.titleSuffix,this.titleSuffix,"","titleSuffix",!0),Ue(b,d,u,w.subtitleSuffix,this.subtitleSuffix,"","subtitleSuffix",!0),Ue(b,d,u,w.description,this.description,""),Ue(b,d,u,w.helpUri,this.helpUri,""),Ue(b,d,_,w.icon,this.icon,x),Ue(b,d,u,w.titleImageUri,this.titleImageUri,void 0),u.statusBar?this._onStatusBarClick=function(e,t,i,n){let s,o,a=!1;const r=ko.observable(),l=t=>{let l=!1;const d=t.onClick||t.onActivated;o&&(o.dispose(),o=void 0,s=void 0);const c=MsPortalFx.find($e(e),(t=>t.masterCommandName===de.format(e.bladeDefinition.name)&&t.masterPartId===e.id));if(c&&He(e.diContainer).forceCloseBlade(c),t.selection){l=!0,o=e.createChildLifetime(),s=(0,M.createOpenBladeCommand)(o,e.diContainer,e,e.bladeDefinition,e.extension,de.format(e.bladeDefinition.name)),r(s.viewModel.container),r().selectable.selectedValue(t.selection);const i=!$e(e).length;n()&&i&&!a&&(s.execute(!1),a=!0)}else d&&d.uri?(l=!0,o=e.createChildLifetime(),s=(0,M.createOpenLinkCommand)(o,e.diContainer,e,e.bladeDefinition,e.extension,de.format(e.bladeDefinition.name),d)):t.onClick&&(l=!0);i.contentState(t.state),i.contentStateDisplayText(t.text),i.statusBar.activatable(l)},d=e=>{e&&0!==e.state||(e={text:"",state:0,selection:null}),l(e)};return t.subscribeAndRun(e,d),ko.reactor(e,(()=>{const e=r()&&r().selectable.isSelected(),n=xe(t);i.statusBar.activated(e),e&&n&&"function"==typeof n.onActivated&&n.onActivated()})),()=>{s&&s.execute(!1);const e=xe(t);if(e){const t=e.onClick;t&&("function"==typeof t?t():"function"==typeof t.onLinkOpened&&t.onLinkOpened(!1))}}}(this,u.statusBar,this.widget.options,this._isOpenedByReferrer):(Ue(b,d,u,w.contentState,ko.observable(0),0),Ue(b,d,u,w.contentStateDisplayText,ko.observable(""),"")),ko.reactor(this,(()=>{const e=f.icon(),t=Oe(o)?!e:MsPortalFx.deepEquals(e,y.defaultSvg);f.hasIcon(!t)}))}return e})).catch((t=>{const i=`Unable to get extension view model for blade '${this.locator.toString()}'. Error: ${MsPortalFx.getLogFriendlyMessage(t)}`;return X.Error.isBaseOf(t)&&0===t.errorLevel||oe.error(i),e.options.title((0,C.getDefaultTitle)(this.locator.name)),this._hasPermissionsDeferred.resolve(void 0),Promise.reject(new X.CanceledError(i))}))}else e.options.title((0,C.getDefaultTitle)(this.locator.name)),this._initialOnInputsSetDeferred.resolve(),this._hasPermissionsDeferred.resolve(void 0)}_createBindViewModelConfiguration(e){return{bindableTarget:{viewModelName:e},inputs:this.bladeDefinition.viewModelInputs,referenceComposition:this,inputsSetCalled:(e,t)=>{t.finally((()=>{($.isEmptyObject(this._lastInputsSetProperties)||(0,F.deepSubset)(e,this._lastInputsSetProperties))&&this._lastInputsSetDeferred.resolve(void 0),this._initialOnInputsSetDeferred.resolve()}))},customInputBindingValidator:e=>{if(1!==e.valuesFrom[0].referenceType&&5!==e.valuesFrom[0].referenceType&&!e.optional)return"Blade view model binding can only use 'BladeInput' and 'Constant' reference types."},beforeViewModelPropertyUpdate:e=>{const t=this.bladeDefinition;if((t.optionalInputs||[]).forEach((t=>{void 0===e[t]&&delete e[t]})),t.permissions&&!(0,F.bladeImplementedWithVirtualPart)(t)){const i=this.locator.toString();return(0,z.checkPermissions)(t.permissions,ie.All,e,t.assetType,this.extension.name,this.diContainer,i).then((e=>(this._updateForHasPermissions(e).then(null,(e=>{oe.error(e)})),e)))}return this._hasPermissionsDeferred.resolve(void 0),Promise.resolve(!0)}}}_setupPreviewListener(e,t){const i=this.containerWidget.options;if(this.diContainer.get(h.ManifestCache).getManifest(e.name,"assetTypes").isPreview)i.showPreviewTag(!0);else if(t.assetType){const n=this.diContainer.get(g.AssetTypeService);MsPortalFx.tryImmediateResolve(n.assetTypesComplete,(()=>{const s=n.getAssetType(e.name,t.assetType);s&&i.showPreviewTag(s.isPreview)}))}else Promise.resolve(this._extensionViewModel).then((e=>{if(e){const t=e.container;t.preview.subscribe(this,i.showPreviewTag),i.showPreviewTag(t.preview())}}))}_renderNotice(e){if(!(0,F.bladeImplementedWithVirtualPart)(this.bladeDefinition))for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);const t=this.containerWidget;if(t&&t.options){const i=this.widget.options;i.contentState(0),i.contentStateDisplayText(""),void 0!==e.bladeTitle&&i.title(e.bladeTitle),void 0!==e.bladeSubtitle&&i.subtitle(e.bladeSubtitle),i.titleSuffix(""),i.subtitleSuffix(""),Te(t,i,this.bladeDefinition);const n=new l.ViewModel(this.widget.ltm||this);n.header(e.noticeHeader),n.title(e.noticeTitle),n.description(e.noticeDescription),n.imageType(e.noticeImageType),n.callToActionText(e.noticeCallToActionText),n.callToActionUri(e.noticeCallToActionUri),i.noticeTmplVm(n),p.FocusHandler.Instance.notifyContainerReadyForFocus(this.widget)}e.shouldDisableBlade&&(this._disabled=!0,this.bindings=[],this._releaseResources()),this._compositionDeferred.resolve()}_renderError(e,t){const i=this.locator;if(this.bladeDefinition=this.bladeDefinition||{name:i&&i.name,lenses:[],locked:!0},!(0,F.bladeImplementedWithVirtualPart)(this.bladeDefinition))for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);let n;n="string"==typeof e?{message:e}:e;const s=this.containerWidget;this.bladeDefinition?.menuBlade&&s?.element.removeClass(pe);if(s&&s.options){const e=this.widget.options;(o=e).subtitle(""),o.titleSuffix(""),o.subtitleSuffix(""),o.description(""),o.helpUri(""),o.contentState(0),o.contentStateDisplayText(""),o.disabled(!0),Te(s,e,this.bladeDefinition),void 0!==t.bladeTitle&&e.title(t.bladeTitle),void 0!==t.bladeSubtitle&&e.subtitle(t.bladeSubtitle);const a=new I.ViewModel(n,{sessionId:MsPortalFx.sessionId,extName:this.extension&&this.extension.name||this.locator&&this.locator.getExtensionName(),contentName:i&&i.name,resourceId:this._findResourceId(),code:t.fallbackErrorCode}),r=new M.CompositionInstanceCommandContext($(this.containerWidget.element)[0],null,this),l=new B.GoToAssetBlade(this,this._diContainer,this);l&&(l.bind(r),l.enabled()&&a.commands.push(l)),e.errorTmplVm(a),p.FocusHandler.Instance.notifyContainerReadyForFocus(this.widget)}var o;this.getDeepLink().then((e=>{e&&e!==location.href&&(0,r.pushState)({data:{},url:e})})),this._disabled=!0,this._releaseResources()}_disposeEditScopes(){const e=this.editScopeId();e&&this.diContainer.get(f.EditScopeManager).onEditScopeDisposed(e);const t=this._journey;if(t){const e=this.journeyPath;t.ambientSettings.getItemsInPath(e).forEach((e=>{e.value&&e.value.editScope&&this.diContainer.get(f.EditScopeManager).onEditScopeDisposed(e.value.editScope.editScopeId)})),t.ambientSettings.removeItemsInPath(e)}}_clearEditScopeId(){if(!this.bladeDefinition.editScopeType)return;const e=this.editScopeId(),t=e&&this.diContainer.get(f.EditScopeManager).getStateObservable(e);t&&0===t()&&this.diContainer.get(f.EditScopeManager).onEditScopeDisposed(e),this.editScopeId(void 0),this._shellViewModel[F.EditScopeIdPropertyName](void 0)}_createChildrenFromDefinition(e){if(!this._childrenCreated){if(e.lenses){const t=[];e.lenses.forEach((i=>{const n=this.locator.withLens(i.name),s=N.create(this.diContainer,n,e.locked&&this._sequenceNumber);i.isSummary?t.unshift(s):t.push(s)})),this.addChildren(t)}this._childrenCreated=!0}}_removeRedirectParts(){this.children.filter((e=>{const t=e.children.filter((e=>{const t={};return this._finder.tryLocate(e.locator,t)&&!!t.value.redirectMode})),i=e.children.length&&t.length===e.children.length;return t.forEach((t=>{e.removeChild(t)})),i})).forEach((e=>{this.removeChild(e)}))}_composeChildren(e=this.children){const t=[],n=[],s=this._summaryCollapsed();let o,a=0;if((0,i.isFeatureEnabled)("bladefullreadytimeout")){a=setTimeout((()=>{const e=MsPortalFx.extend({resourceId:this._findResourceId(),partStates:o},this._perfData);this._trace({action:"BladeLoadErrored",actionModifier:ke[ke.FullReadyTimeout],data:e,duration:a})}),L.bladeFullReadyTimeout)}e&&e.length&&e.forEach((e=>{s.then((i=>{this._bladeSummaryCollapsed=i,e.compose(this.widget),t.push(e.await(7)),n.push(e.await(3)),e.children.concat([e]).forEach((e=>{t.push(e.await(7)),n.push(e.await(3))}))}))})),s.finally((()=>{Promise.all(t).then((()=>{this._perfData.bladeOpenedTime=se()-this._telemetry.readyStartTime})).finally((()=>{this._composing=!1,this.save()})),Ie(this,Promise.allSettled(n)).then((e=>{o=e,this._telemetry.traceBladeComplete(e,a,Be(this)),p.FocusHandler.Instance.notifyContainerReadyForFocus(this.widget)})),Promise.all(n).then((e=>{this.bladeDefinition.menuBlade||this.bladeDefinition.tabMenuBlade||this._announce.read(le.bladeReady)})),Promise.allSettled(n).then((()=>{const e=this.getParts();Promise.allSettled([...e.map((e=>this.notifyPartComposed(e)))]).then((()=>{this.containerWidget.options.printEnabled(e.every((e=>{let t=!0;if(e.definitionExists){const i=MsPortalFx.Parts.PartKind,n=e.partDefinition&&e.partDefinition.partKind;t=n!==i.Frame&&n!==i._Internal_App}return t})))}));const t=new CustomEvent("fxtriggertourguide",{detail:{extensionName:this.extension.name,bladeName:this.bladeDefinition.name},bubbles:!0});this.widget?.element?.[0]?.dispatchEvent(t)}))}))}getPerfData(){return MsPortalFx.extend2(this._perfData,this.menu&&this.menu.getTelemetryInfo())}_composeAndRestoreLayout(){const e=this.containerWidget;this._removeRedirectParts(),this._composeChildren();let t=Promise.resolve();const i=this.bladeDefinition.actionBar;if(!this._rebinding&&i){const e=this.locator.withBladeActionBar(i.name);t=MsPortalFx.tryImmediateResolve(MsPortalFx.require("MsPortalImpl/UI/Compositions/UI.Composition.BladeActionBar"),(t=>{const i=this.actionBar=t.create(this.diContainer,e);i.parent=this,i.compose(this.widget),this.registerForDispose(this.actionBar)}))}return 2===e.options.displayState()&&e.refreshDisplayState(),t}_getCommands(){if(!this.isComposed||!this.widget)throw new Error(`Blade '${this}' needs to be composed before retrieving its commands.`);return this.widget.options.commandBar.menuItems()}_attachEventHandlers(e,t,i,n,s,o,a,r,l){const d=e.element,c=t.element,h=e.options;if(i)r||!l||o||l.clearHeaderContent();else{if(c.on("fxregistermenu",((t,i)=>{const n="Default",s=Me(this.locator);i.onItemClick(((e,t)=>{this._trace({action:"MenuItemClick",actionModifier:n,data:$.extend({blade:s,type:i.getResourceType()||this.assetType},t),source:"Blade",name:e})})),i.setDefaultId({recommendedId:this.defaultMenuItemId,bladeReference:this.contentBladeReference}),i.onSearchMiss((e=>{G.usingState((()=>{this._trace({action:"MenuBladeSearchMiss",actionModifier:n,data:$.extend({blade:s,type:i.getResourceType()||this.assetType},e),source:"Blade"})}),this._creationState)})),this.await(4).finally((()=>{const e=i.getResourceType()||this.assetType;G.usingState((()=>{const t=$.extend({blade:Me(this.locator),type:e},i.getTelemetryInfo());this._trace({action:"MenuBladeInfo",actionModifier:n,data:t,source:"Blade"})}),this._creationState),e&&h.associatedWithAsset(!0)})),ko.reactor(this,(()=>{e.options.titleSuffix(i.selectedItemText())})),this.menu=i})),!a||!n){let t;h.close=()=>{const e=He(this.diContainer),t=e.tryCloseBlade(this,1);if(t){const t=e.activeJourney();if(t){const e=t.children,i=e[e.length-1];s&&i.menu.selectDefaultItem();this.containerWidget.options.favoriteResourceButton.configure(i.masterContainer,i.containerWidget.options)}}return t},h.pinblade=()=>{t&&t.dispose(),t=this.createChildLifetime();const i=new P.Pin(t,this.diContainer);i.bind(new M.CompositionInstanceCommandContext(e.element[0],(()=>Promise.resolve(e.getContentWidget())),this)),i.execute(!1)},h.shareItBlade=()=>{const e=(0,j.getModelValue)(this._shellViewModel,"id").value();this._diContainer.get(k.ShareResource).openContextPane(e,this.bladeDefinition.name)};const i=new P.Edit(this.createChildLifetime(),this.diContainer,(e=>{h.editState(e)}));h.editblade=()=>{i.bind(new M.CompositionInstanceCommandContext(e.element[0],(()=>Promise.resolve(e.getContentWidget())),this)),i.execute(!1)},h.resetEditCommand=()=>{i.reset()}}a&&l&&!n&&(l.clearHeaderContent(),l.clearDetailContent())}t.options.commandBar.itemSelected=(e,i)=>{const n=i.item;if(n&&n.enabled()&&!n.unauthorized()){const e=i.popupTarget,s=e?{getForm:()=>e,showForm:MsPortalFx.noop,hideForm:MsPortalFx.noop}:t;n.bind(new M.CompositionInstanceCommandContext(t.element[0],(()=>Promise.resolve(s)),this)),n.execute(!1);const o=i.item.commandDefinition;o&&o.details&&Le(this,(e=>e.masterCommandName===o.name))}},t.options.commandBar.locator=this.locator,this._disposablesEvents.push(c.setEvents([w.Widget.viewSettingsChanged,(e,t)=>{this.widgetState(t),this.save(1),e.stopPropagation()}],["fxbladestatusbarclicked",e=>{this._onStatusBarClick&&this._onStatusBarClick()}]),d.setEvents(["fxensurebladevisible",(e,t)=>{Le(this,(e=>!e.masterCommandName&&e.masterPartId===t.masterPartId))}],["fxsummarycollapsed",(e,t)=>{t.collapsed=this._bladeSummaryCollapsed}],["fxgotodefaultitem",e=>{this.menu&&this.menu.selectDefaultItem()}]))}_composeShellCommands(e,t,i){const n=[],s=this.diContainer,o=this.containerWidget.options;if(this.isPinnable()){const e=this.bladeDefinition,t=5===(0,F.getBladeType)(e),i=new P.Pin(this,s);o.pinVisible(!t),e&&e.hasOnPinMethod?this.getOnPinFunction().then((e=>{e&&(t&&o.pinVisible(!0),i.activate(),o.pinEnabled(!0))})):(i.activate(),o.pinEnabled(!0))}o.favoriteResourceButton.configure(this.masterContainer,o),o.editAssetButton.configure(this.masterContainer,o),o.resetEditCommand&&o.resetEditCommand(null),this.isEditable()&&(o.editVisible(!0),o.editEnabled(!0)),n.push((0,P.getDisplayStateCommand)(s,1),new P.ResetLayout(this,s,t,i)),_e.arrayPushAll(e,n)}_validateParameters(t,i,n){const o=this.getViewModel(),a=(i.inputs||[]).filter((e=>!(0,j.getModelValue)(o,e).exists));if(a.length){let i;if(this.masterPartId){const t=MsPortalFx.find(this.masterContainer.getComposedParts(),(0,F.getIdMatchFunc)(this.masterPartId)),n=this.diContainer.get(O.Finder).findPartsContainer(t),o=t&&t.partDefinition&&t.partDefinition.shareVmWithParentBlade?n&&n.locator:t&&t.locator;i=`The ${1===o.type?"blade":"part"} ${Me(o)} failed to supply all the required parameters. The missing the required parameter(s) '${a.join(", ")}'.`;const r=`Failed to open the blade ${Me(this.locator)}. ${i}`;(0,s.logToExtension)(e,ve(o),2,r)}else i=`The link '${this.openedByInfo.openedByContext.deepLink}' is missing the required parameter(s) '${a.join(", ")}'.`;this._composeErrorBlade(t,n,ke.ErrorInitializing,i)}return!a.length}_validateDefinition(e,t,i){let n=!0;const s=[],o="A blade cannot be the owner of an edit scope and also receive an edit scope id from an external source.";return t.assetType&&!t.assetIdInputProperty?(s.push("'assetIdInputProperty' is required if 'assetType' is defined on blade definition."),n=!1):t.inputs&&t.outputs&&(n=!t.inputs.some((e=>{const i=t.outputs.indexOf(e)>=0;return i&&s.push(`Property '${e}' cannot be marked as input and output.`),i}))),n=n&&W.CompositionBinder.validateInputBindings(this,t.bindings,s,(e=>1===e.valuesFrom[0].referenceType?"Blade bindings cannot reference BladeInputs.":ge(t.inputs)&&t.inputs.indexOf(e.property)>=0?`Blade bindings that target a blade input are not supported. Inputs: '${be(t.inputs)}'. Bindings: '${be(t.bindings)}'.`:t.editScopeType&&e.property===F.EditScopeIdPropertyName?`Declaring an 'editScopeType' and an input binding with '${F.EditScopeIdPropertyName}' as a target property is not supported. ${o} Bindings: ${ye(this.bindings)}`:void 0)),n&&t.editScopeType&&ge(this.masterInputKeys)&&this.masterInputKeys.includes(F.EditScopeIdPropertyName)&&(n=!1,s.push("Declaring an 'editScopeType' and receiving an '"+F.EditScopeIdPropertyName+"' from invocation values is not supported. "+o+` Invocation Properties: ${ye(this.masterInputKeys)}.`)),n&&W.CompositionBinder.modelHasPropertiesWithValue(this+"",t.templateKeyInputs,this.getViewModel()),s.length&&oe.error(`${s[0]} Blade:'${this.locator}'.`),n||this._composeErrorBlade(e,i,ke.ErrorInitializing,"Unable to initialize blade from definition."),n}_findResourceId(){return this.assetId()||this.parent&&this.parent.getCurrentResourceId()}async _getExtensionPerfData(){const e=await this.bladeDefinitionPromise,t=e.viewModelBundleLoading;if(e.viewModelBundleLoading=null,!Oe(e))return;const i=await this._bladeViewModelDeferred.promise,n=i?.internal;if(n){if(t){const e=n.getViewModelStart,i=t.end;e&&i&&(this._perfData.getViewModelDelay=e-i),this._perfData.bundleLoadingTime=t.duration}const e=n,i=t=>{e[t]?.subscribeAndRun(this,(e=>{!MsPortalFx.isNullOrUndefined(e)&&(this._perfData[t]=e)}))};i("prepareFirstAjaxTime"),i("ajaxTime"),i("onInitializeAsyncTime"),i("reactViewInitializeEnd"),i("preAjaxRpc"),n.interruptedParent&&(this._perfData.interruptedParent=!0)}}}function Ve(e){return{id:Me(e.locator),instanceId:e.instanceId}}function Le(e,t){const i=$e(e);for(let e=i.length-1;e>=0;e--){const n=i[e];if(t(n)){const e=n.containerWidget;if(e){const t=document.activeElement;t&&$.contains(e.element[0],t)||setTimeout((()=>{e.setFocus()}),150)}break}}}function Ue(e,t,i,n,s,a,r,l){(0,j.getModelValue)(i,n).exists?e.mapProperty(n,r||n).bind(t,i,!0,(()=>{const e=ko.unwrap((0,j.getModelValue)(i,n,!0).value);s(e||a)})):l||o.isDesktopTraceEnabled&&oe.warning(`The Blade VM with id ${t} is missing the ${n} field.`)}function We(e,t,i){ce&&oe.verbose(`[BladeRebinding] ${t} Blade: ${e}. Updated Properties: ${be(i,null,2)||"N/A"}`)}function Oe(e){const t=(0,F.getBladeType)(e);return 3===t&&e.menuBlade.isV2||6===t&&e.tabMenuBlade.isV2||1===t&&e.templateBlade.isV2||2===t||5===t}function Ne(e){const t=e.getInputPropertyBindings();return!!(0,_.getGalleryItemIdFromBladeComposition)(ve(e.locator),e.locator.name,t&&t.targetModel)}function He(e){return e.get(D.JourneyManager)}function $e(e){return e.diContainer.get(O.Finder).findBlades(e)}t.Instance=Ae}));