define("MsPortalImpl/UI/Compositions/UI.Composition.Selectable2Registrar",["require","exports","Fx/DependencyInjection","MsPortalImpl/Base/Base.Selectable2","MsPortalImpl/UI/UI.BladeOpener","MsPortalImpl/UI/Compositions/UI.Composition.BladeOpener","MsPortalImpl/Base/Base.ImplUtils","MsPortalImpl/Base/Base.Events","MsPortalImpl/UI/UI.LinkHandler"],(function(e,t,r,a,n,o,l,i,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.discoverSelectables=t.attachFxClickHandler=t.getListSelectableWithClickHandler=t.getSelectableWithClickHandler=t.createFxColumnSelectable=t.registerOpenBladeCommands=t.registerSelectables=void 0;var c=MsPortalFx.Base.Diagnostics,d=o.createOrGetInternalSelectionState,u=a.getFxClickSelectable,p=a.getOrCreate,m=a.findExtensionViewModel,f=a.getOrCreateOpenBladeSelectable,g=MsPortalFx.Base.Diagnostics.Telemetry.trace;const h=c.createLog(e),b="fxclick",C="href",k="fxs-fxclick",x=15,v=["_msPortalFxShell","_msPortalFxOpenBladeSelectable","_msPortalFxSelectable","_msPortalFxSelectable2"],I=["selectable","activeOpenBladeCommand"];t.registerSelectables=function(e,t,r,a){const n=new Map,o=()=>{!function(e,t,r){const a=O(t);ko.ignoreDependencies((()=>{const t=[];e.forEach(((e,r)=>{a.has(r)||t.push(e)})),t.forEach((t=>{e.delete(t.selectable)})),a.forEach(((t,a)=>{e.has(a)||(!function(e,t,r){const a=r.getBladeOpener(),n={invocationInputArguments:[{valuesFrom:[{referenceType:0,property:t.path}]}]},o=p(r.diContainer,t.selectable);a.registerInvocationProperty(n,void 0,o)}(r.diContainer,t,r),e.set(a,t))}))}))}(n,t,r)};a?ko.computed(e,o).extend({rateLimit:{timeout:100,method:"notifyWhenChangesStop"}}):o()},t.registerOpenBladeCommands=function(e,t,r,a,n){const o=e.filter((e=>10===e.type));if(0===o.length)return!0;if(!function(e,t){e=e||[];const r="Found {0} OpenBladeCommmand2 items with a null or undefined '{1}' property. Source: '{2}'";function a(a){const n=e.filter((e=>!e[a]));return n.length&&h.error(r.format(n.length,a,t)),!!n.length}if(["id","selectable"].some(a))return!1;const n=e.map((e=>e.id)),o=function(e){const t={},r=[];return(e||[]).forEach((e=>{t[e]&&r.push(e),t[e]=!0})),r}(n);if(o.length)return h.error("Found multiple OpenBladeCommand2 items have the same id. Ids must be unique. Duplicate Id(s): '{0}', Source: '{1}'".format(JSON.stringify(o),t)),!1;return!0}(o,r.locator))return!1;const l=d(t)[a],i={};return o.forEach((e=>{const a=e.selectable,n=p(r.diContainer,a);i[n.id]=a,n.registerForDispose({dispose:()=>{const e=MsPortalFx.clone(l(),!1);delete e[n.id],l(e)}}),ko.reactor(n,(()=>{n.isSelected()&&t.internal.activeOpenBladeCommand(e)}))})),l(i),!0};const P="msportalfx-activated",F=`${P} ext-${P}`;let y=0;function A(e){let t=MsPortalFx.Base.ProxiedObservables.data(e,b);return t||(t=b+y++,MsPortalFx.Base.ProxiedObservables.data(e,b,t)),t}function B(e,t,r,a){const n=m(r);if(n){const r=A(t),o=f(e,r,n);return o.onClick=()=>{o.invokeClickCallback(1,n,t,a)},o}}function S(e,t){try{let r=ko.unwrap(e[t]);return(Array.isArray(r)||"object"!=typeof r)&&(r=void 0),r}catch(e){return}}function M(e,t){return e?e+"."+t:t}function O(e){const t=new Map;return w(e,"content",t),w(e,"container",t,v),w(e,"internal",t,I),t}function w(e,t,r,a){const n=S(e,t),o=[{path:t,value:n,unprocessedChildProperties:a?a.slice():E(n)}];for(;o.length;){const e=o[o.length-1];if(e.unprocessedChildProperties.length){const t=e.unprocessedChildProperties.shift(),a=S(e.value,t);if(a)if(FxImpl.isSelectable2(a))r.set(a,{path:M(e.path,t),selectable:a});else if(o.length<x){const r={path:M(e.path,t),value:a,unprocessedChildProperties:E(a)};o.push(r)}}else o.pop()}}function E(e){return Object.keys(e).filter((e=>{return!(95===(t=e).charCodeAt(0)&&(109!==t.charCodeAt(1)||115!==t.charCodeAt(2)||80!==t.charCodeAt(3)||111!==t.charCodeAt(4)||114!==t.charCodeAt(5)||116!==t.charCodeAt(6)||97!==t.charCodeAt(7)||108!==t.charCodeAt(8)||70!==t.charCodeAt(9)||120!==t.charCodeAt(10)));var t}))}t.createFxColumnSelectable=function(e,t,r,a,o){const l=m(a);let s,c;const d=ko.observable(),u=f(e,"FxGrid_"+o,l,(e=>{const r=e;ko.reactor(t,(()=>{const t=r.activationState();if(t){const r=t.current&&t.current.item;r!==c&&(d(e.value()),c=r,c&&s&&(s.trigger($.Event("fxselectableactivated",{activated:d})),s=null))}}))}));return{activated:d,invokeClick:(e,t,a)=>{const n=l&&l.internal&&l.internal.elements||ko.observableArray(),o=(0,i.getOrCreateFxElement)(t[0],n);u?(s=t,u.invokeClickCallback(3,l,r,e,o,{row:a,element:o})):e({row:a,element:o})},openBlade:async(t,r,a)=>{u&&(s=r,e.get(n.BladeOpener).openBlade(t,{selectable:u,flags:0,selectedItem:a}))},openContextPane:async(t,r,a)=>{u&&(s=r,e.get(n.BladeOpener).openBlade(t,{selectable:u,flags:1,selectedItem:a}))}}},t.getSelectableWithClickHandler=B,t.getListSelectableWithClickHandler=function(e,t,r,a){const n=B(e,t,r,$.noop),o=n,l=m(r);return o.onClick=e=>{n.invokeClickCallback(3,l,t,a,void 0,e.item,e.metadata)},o},t.attachFxClickHandler=function(t,a,n,o){const i=o||new FxImpl.TriggerableLifetimeManager;o||ko.utils.domNodeDisposal.addDisposeCallback(t,(()=>{i.dispose()}));const c=$(t),d=a.$data,p=a.$dicontainer||r.container,m=u(p,i,c,b,A(d)),f="A"===t.tagName;let h=!0,x=!0;const v=e=>{e=x||!!e,t.setAttribute("aria-disabled",`${e}`),c.toggleClass("azc-text-disabled",e);const r=ko.unwrap(a.$tabIndex),n=e?-1:r||0;t.setAttribute("tabindex",`${n}`)};let I,y=(e,t,r)=>!0;const B=ko.observable(""),S=(0,s.getLinkTelemetryLogger)(c,B,"LinkRightClicked");t.addEventListener("contextmenu",(e=>{S()})),ko.reactor(i,(()=>{try{I&&I.dispose(),I=i.createChildLifetime();const r=ko.unwrap(n);B(r?.telemetryName||""),ko.ignoreDependencies((()=>{let n;if("function"==typeof r){const a=r;n=r=>{r.stopPropagation();const n=f&&t.getAttribute(C)||"";if(s.defaultHref===n)r.preventDefault();else if(f&&"keydown"===r.type&&(13===r.which||32===r.which&&"button"===t.getAttribute("role"))||"BUTTON"===t.tagName&&(32===r.which||13===r.which))return;Q.isPromiseAlike(a)&&l.logToExtension(e,t,2,FxImpl.createError("fxclick binding argument is not a callback function. The click handler is "+a)),m.invokeClick(d,a,r)}}else if(n=r,n?.attachHoverCard){const t=ko.unwrap(n.resourceId);MsPortalFx.Base.Promises.cancelOnDispose(i,Promise.all([MsPortalFx.require(e.normalize("MsPortalImpl/Widgets/Widgets.HoverCard")),MsPortalFx.require(e.normalize("MsPortalImpl/Widgets/ResourceHoverCard"))])).then((([e,r])=>{e.attach(i,c.parent(),".fxs-fxclick",(a=>{const n=new r.ViewModel(t,$(a.currentTarget),p);return n.positionHint=3,g({source:"ResourceHoverCard",action:"InitialReveal",name:t,data:{hoverCardLocation:r.HoverCardSource.ResourceLink}}),new e.Widget(e.getBalloonElement(t,r.HoverCardSource.ResourceLink),n,p)}),p)}))}const o=(0,s.getUriAndHandler)(I,p,n,!f);let u=x;o.uri.subscribeAndRun(I,(e=>{if(x=!e,(a.$disabled||u!==x)&&(u=x,v(a.$disabled&&a.$disabled())),f){let r=!1;h&&(r=!!t.getAttribute(C)),r&&e===s.defaultHref||(e?(t.setAttribute(C,e),h=!1):(t.removeAttribute(C),h=!1))}})),o.errorMessage.subscribeAndRun(I,(r=>{r&&l.logToExtension(e,t,1,FxImpl.createError(`fxclick failure: ${MsPortalFx.getLogFriendlyMessage(r)}`))})),y=o.handler}))}catch(r){l.logToExtension(e,t,2,FxImpl.createError(`fxclick failed to read value: ${MsPortalFx.getLogFriendlyMessage(r)}`))}})),ko.reactor(i,[a.$disabled,a.$tabIndex],v),t.classList.add(k);const M=r=>{if(ko.unwrap(a.$disabled)||"true"===t.getAttribute("aria-disabled")){if("click"===r.type||"keydown"===r.type&&(13===r.which||32===r.which&&("BUTTON"===t.tagName||"button"===t.getAttribute("role"))))return!1}else try{return y(r,m,B())}catch(r){l.logToExtension(e,t,2,FxImpl.createError("fxclick failed to execute click handler",{innerErrors:r,data:{databind:$(t).attr("data-bind")}}))}};i.registerForDispose([()=>t.classList.remove(k),c.setEvents(["click",M],["keydown",M])]),m.activated.subscribeAndRun(i,(e=>{const t=!!e;!function(e,t){t?(e.closest(".fxs-part-content").find("."+P).removeClass(F),e.addClass(F)):e.removeClass(F)}(c,t),t&&c.trigger($.Event("fxselectableactivated",{activated:m.activated}))}))},t.discoverSelectables=O}));