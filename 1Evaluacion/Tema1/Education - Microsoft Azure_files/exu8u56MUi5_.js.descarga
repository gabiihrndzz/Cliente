define("@microsoft/azureportal-reactview/ControlPlaneValidators",["require","exports","@microsoft/azureportal-reactview/internal/ReactView","@fluentui/react/lib/Styling","@fluentui/merge-styles/lib/mergeStyleSets","@microsoft/azureportal-reactview/FrameworkIcon","@microsoft/azureportal-reactview/Az","@fluentui/react/lib/Text","react","@microsoft/azureportal-reactview/ResourceManagement","FxInternal/Resources/ControlPlaneValidatorsResources","@microsoft/azureportal-reactview/FormLabel","@microsoft/azureportal-reactview/internal/BaseFunctionProxy","@fluentui/react/lib/Stack","@fluentui/react/lib/Link","@microsoft/azureportal-reactview/internal/FormLabel","@microsoft/azureportal-reactview/internal/DefaultResourceValidation","lodash"],(function(e,t,l,a,o,n,i,r,s,c,u,d,m,y,p,f,h,P){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ControlPlanePolicyEvaluator=t.withControlPlanePolicySelector=t.withControlPlanePolicyValidator=t.ControlPlanePolicyScopeContext=void 0,t.ControlPlanePolicyScopeContext=s.createContext(null);t.withControlPlanePolicyValidator=function(e){return l=>{const a=s.useContext(t.ControlPlanePolicyScopeContext),[o,n]=s.useState(void 0),[i,r]=s.useContext(h.DefaultResourceValidationContext);(0,d.useValidationEffect)((()=>[k(a,o,{...l.componentOptions})]),[o,a]);const c=s.useCallback(((e,t)=>{l.onChange?.(e,t),n(t)}),[l.onChange,n]),u=s.useMemo((()=>[{skipDefault:!0,resourceTypes:[]},r]),[r]),{componentOptions:m,...y}=l;return s.createElement(h.DefaultResourceValidationContext.Provider,{value:u},s.createElement(e,{...y,onChange:c}))}};t.withControlPlanePolicySelector=function(e){return l=>{const a=s.useContext(t.ControlPlanePolicyScopeContext),o=(0,f.useFormLabelUIContext)(),n=w(),i=s.useMemo((()=>void 0===l.options?[{key:"false",text:"false"},{key:"true",text:"true"}]:l.options?.slice()),[l.options]),r=l.componentOptions;let c=r.additionalTelemetry;(c||(c={})).__mode=b.ControlPlaneModes.Selector,l={...l,componentOptions:r};const[u,d]=s.useState(null),[m,y]=s.useState(null);s.useEffect((()=>{m!==u?.key&&y(u?.key)}),[u]),s.useEffect((()=>{m!==l.selectedKey&&y(l.selectedKey)}),[l.selectedKey]);const p=new I({...r,convertValue:r.convertValue??(e=>e&&e.key&&e.key.toString())},i,[m,y],n,_);s.useEffect((()=>{let e=!0;const t=a;if(t){o?.setLoading(!0);const l=p.getAllowedValues();__InternalAzurePortal.AzInternalApi.internalApi.getBladeContext().then((a=>{e&&V({scope:t,resolvedValuesToField:l,bladeName:a?.id,resourceTypeMetadata:r.resourceTypeMetadata,allowEmptyValues:r.allowEmptyValues,additionalTelemetry:r.additionalTelemetry}).then((t=>{if(e){const e=v(t,a?.id,r.additionalTelemetry);p.setDeniedValues(a?.id,t.deniedValues,e),o?.setLoading(!1)}}))}))}return()=>{e=!1}}),[l.options,a]),s.useEffect((()=>{o?.setSublabel(p.getProps().sublabel)}),[p.getProps().sublabel]);const h=s.useCallback(((e,t,...a)=>{d("boolean"==typeof t?i.find((e=>JSON.stringify(t).toLowerCase()===e.key.toString().toLowerCase())):t),l.onChange(e,t,...a)}),[l.onChange,d,i]),{componentOptions:P,...C}=l;return s.createElement("div",null,s.createElement(e,{...C,options:i,selectedKey:m,checked:"true"===m||"false"===m?JSON.parse(m):m,disabled:p.getProps().disabled,onChange:h}))}},t.ControlPlanePolicyEvaluator=async function(e,t){const l=e,a=w();let o=t.additionalTelemetry;(o||(o={})).__mode=b.ControlPlaneModes.PolicyEvaluator,t={...t,additionalTelemetry:o};const n=await __InternalAzurePortal.AzInternalApi.internalApi.getBladeContext(),i=V({...t,scope:l,bladeName:n?.id}),r=await i,s=v(r,n?.id,t.additionalTelemetry);return{...r,allErrorResults:s,customHtml:_(s,a,!1)}};const C=(0,a.mergeStyles)({marginLeft:"5px"}),g=(0,m.getBaseFunctionProxy)(),S=(0,a.mergeStyles)({marginLeft:"30px"}),E=(0,o.mergeStyleSets)({icon:{float:"left",marginRight:"8px"},iconSmall:{width:16,height:16}}),b={ControlPlanePolicy:"ControlPlanePolicy",PolicyBladeLinkClicked:"PolicyBladeLinkClicked",PolicySelectorChangedSelection:"PolicySelectorChangedSelection",ControlPlaneModes:{PolicyEvaluator:"PolicyEvaluator.React",Validator:"Validator.React",Selector:"Selector.React"},PolicySelector:{AutoSelected:"AutoSelected",Cleared:"Cleared"}};async function k(e,t,l){const a=e,o=w();let n=l.additionalTelemetry;(n||(n={})).__mode=b.ControlPlaneModes.Validator;let i=l.allowEmptyValues;T(i)&&(i=!1),l={...l,allowEmptyValues:i,additionalTelemetry:n};const r=await __InternalAzurePortal.AzInternalApi.internalApi.getBladeContext(),s=(e=>{const t=e,a=l.convertValue?l.convertValue(t):t,o=[];return T(a)||"string"==typeof a&&A(a)||function(e){let t=!1;T(e)||"string"!=typeof e||(t=e.startsWith("[")&&e.endsWith("]"));return t}(a)||o.push(a),o})(t);if(a?.scopeId){const e=await V({scope:a,resolvedValuesToField:s,bladeName:r?.id,resourceTypeMetadata:l.resourceTypeMetadata,allowEmptyValues:l.allowEmptyValues,additionalTelemetry:l.additionalTelemetry}),t=v(e,r?.id,l.additionalTelemetry),n=0===e.allErrorResults.length;let i=null;return e.allErrorResults.length&&(i=_(t,o,!1)),{message:i,state:n?2:3}}return{state:2}}function v(e,t,l){return e.allErrorResults.map((({reason:e,policyAssignmentId:a})=>{const o=c.ArmId.parse(a,!0).resourceName;return{policyAssignmentName:o,resourceLink:()=>{x(b.PolicyBladeLinkClicked,t,{},l),i.openBlade({bladeName:"PolicyAssignmentDetailBlade",extensionName:"Microsoft_Azure_Policy",parameters:{id:a}})},linkDisplayName:u.Azure.Validators.Policy.clickDetails,noLinkDisplayName:u.Azure.Validators.Policy.policyDetailsFormat.replace("{0}",o),reason:e,sysViolation:o.startsWith("sys")}}))}function _(e,t,l){const a=[],o=e.find((e=>e.sysViolation));return o?s.createElement("div",{role:"alert"},function(e){const t=/https:\/\/\S+/g,l=e.split(t),a=(0,P.defaultTo)(e.match(t),[]),o=[];return l.forEach(((e,t)=>{o.push(s.createElement("span",{key:`text-${t}`},e)),t<a.length&&o.push(s.createElement(p.Link,{href:a[t],target:"_blank",key:`link-${t}`},a[t]))})),o}(o.reason)):(l?e.forEach((e=>{const l=s.createElement(s.Fragment,null,s.createElement("span",null,s.createElement(r.Text,null,e.reason),t?s.createElement(r.Text,null,e.noLinkDisplayName):s.createElement(p.Link,{className:C,onClick:t=>{e.resourceLink()},underline:!0},`(${e.linkDisplayName})`)),s.createElement("br",null));a.push(l)})):e.forEach((e=>{const l=s.createElement("span",{role:"alert"},s.createElement(r.Text,null,e.reason),t?s.createElement(r.Text,null,e.noLinkDisplayName):s.createElement(p.Link,{className:C,onClick:t=>{e.resourceLink()},underline:!0},`(${e.linkDisplayName})`));a.push(l)})),0===a.length?null:s.createElement(y.Stack,null,a.map(((e,t)=>s.createElement(y.Stack.Item,{key:t},e)))))}function V(e){return g.invoke("___policyDataCore___validatePolicy",e)}function w(){return l.ReactView.getInstance().inContextPane()||!1}function x(e,t,l,a){i.trace([{timestamp:Date.now(),source:b.ControlPlanePolicy,action:e,data:{...l,additionalTelemetry:a,bladeName:t}}])}function T(e){return null==e}function A(e){return T(e)||""===e.trim()}function L(e){const t=e||"";return t.toLowerCase?.()}class I{constructor(e,t,l,a,o){this._options=e,this._copyOfItems=t,this._inContextPane=a,this._getCustomHtml=o,this._states={disabledState:s.useState(),selectedKeyState:l,section:s.useState(null)}}getProps(){return{disabled:this._states.disabledState[0],sublabel:this._states.section[0]}}getItemsObservable(){return this._copyOfItems}getAllowedValues(){const e=[];return this.getItemsObservable()?.forEach((t=>{const l=this._options.convertValue(t);T(l)||e.push(l)})),e}setDeniedValues(e,t,l){let a=0;const o=t.map((e=>L(e)));if(this.getItemsObservable()?.forEach((t=>{const l=L(this._options.convertValue(t));!A(l)&&o.includes(l)?(t.disabled=!0,a++,this._states.selectedKeyState[0]===t.key&&(this._states.selectedKeyState[1](null),x(b.PolicySelectorChangedSelection,e,{event:b.PolicySelector.Cleared},this._options.additionalTelemetry))):t.disabled=!1})),a){const t=this.getItemsObservable().filter((e=>!e.disabled)),a=1===t.length?u.Policy.AutoSelect.info:u.Policy.ItemsAvailability.info,o=this._getCustomHtml(l,this._inContextPane,!0);this._states.section[1](s.createElement("div",{role:"status","aria-live":"polite"},s.createElement("div",null,s.createElement(n.FrameworkIcon,{className:`${E.icon} ${E.iconSmall}`,image:{type:171}}),s.createElement("div",null,a),s.createElement("div",{className:S},o)))),1===t.length&&(this._states.selectedKeyState[1](t[0].key),x(b.PolicySelectorChangedSelection,e,{event:b.PolicySelector.AutoSelected},this._options.additionalTelemetry),this._states.disabledState[1](!0))}else this._states.section[1](s.createElement(s.Fragment,null)),this._states.disabledState[1](!1)}}}));